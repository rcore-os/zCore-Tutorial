<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ğŸš§ Zircon ç”¨æˆ·ç¨‹åº - ç®€æ˜ zCore æ•™ç¨‹</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">ç®€æ˜ zCore æ•™ç¨‹</a></li><li class="chapter-item expanded affix "><a href="zcore-intro.html">ğŸš§ zCore æ•´ä½“ç»“æ„å’Œè®¾è®¡æ¨¡å¼</a></li><li class="chapter-item expanded affix "><a href="fuchsia.html">ğŸš§ Fuchsia OS å’Œ Zircon å¾®å†…æ ¸</a></li><li class="chapter-item expanded "><a href="ch01-00-object.html"><strong aria-hidden="true">1.</strong> å†…æ ¸å¯¹è±¡</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch01-01-kernel-object.html"><strong aria-hidden="true">1.1.</strong> âœ… åˆè¯†å†…æ ¸å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch01-02-process-object.html"><strong aria-hidden="true">1.2.</strong> ğŸš§ å¯¹è±¡ç®¡ç†å™¨ï¼šProcess å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch01-03-channel-object.html"><strong aria-hidden="true">1.3.</strong> ğŸš§ å¯¹è±¡ä¼ é€å™¨ï¼šChannel å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch02-00-task.html"><strong aria-hidden="true">2.</strong> ä»»åŠ¡ç®¡ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch02-01-zircon-task.html"><strong aria-hidden="true">2.1.</strong> ğŸš§ Zircon ä»»åŠ¡ç®¡ç†ä½“ç³»</a></li><li class="chapter-item expanded "><a href="ch02-02-process-job-object.html"><strong aria-hidden="true">2.2.</strong> ğŸš§ è¿›ç¨‹ç®¡ç†ï¼šProcess ä¸ Job å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch02-03-thread-object.html"><strong aria-hidden="true">2.3.</strong> ğŸš§ çº¿ç¨‹ç®¡ç†ï¼šThread å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch03-00-memory.html"><strong aria-hidden="true">3.</strong> å†…å­˜ç®¡ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-01-zircon-memory.html"><strong aria-hidden="true">3.1.</strong> ğŸš§ Zircon å†…å­˜ç®¡ç†æ¨¡å‹</a></li><li class="chapter-item expanded "><a href="ch03-02-vmo.html"><strong aria-hidden="true">3.2.</strong> ğŸš§ ç‰©ç†å†…å­˜ï¼šVMO å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch03-03-vmo-paged.html"><strong aria-hidden="true">3.3.</strong> ğŸš§ ç‰©ç†å†…å­˜ï¼šæŒ‰é¡µåˆ†é…çš„ VMO</a></li><li class="chapter-item expanded "><a href="ch03-04-vmar.html"><strong aria-hidden="true">3.4.</strong> ğŸš§ è™šæ‹Ÿå†…å­˜ï¼šVMAR å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch04-00-userspace.html"><strong aria-hidden="true">4.</strong> ç”¨æˆ·ç¨‹åº</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch04-01-user-program.html" class="active"><strong aria-hidden="true">4.1.</strong> ğŸš§ Zircon ç”¨æˆ·ç¨‹åº</a></li><li class="chapter-item expanded "><a href="ch04-02-context-switch.html"><strong aria-hidden="true">4.2.</strong> ğŸš§ ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li><li class="chapter-item expanded "><a href="ch04-03-syscall.html"><strong aria-hidden="true">4.3.</strong> ğŸš§ ç³»ç»Ÿè°ƒç”¨</a></li></ol></li><li class="chapter-item expanded "><a href="ch05-00-signal-and-waiting.html"><strong aria-hidden="true">5.</strong> ä¿¡å·å’Œç­‰å¾…</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch05-01-wait-signal.html"><strong aria-hidden="true">5.1.</strong> ğŸš§ ç­‰å¾…å†…æ ¸å¯¹è±¡çš„ä¿¡å·</a></li><li class="chapter-item expanded "><a href="ch05-02-port-object.html"><strong aria-hidden="true">5.2.</strong> ğŸš§ åŒæ—¶ç­‰å¾…å¤šä¸ªä¿¡å·ï¼šPort å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch05-03-more-signal-objects.html"><strong aria-hidden="true">5.3.</strong> ğŸš§ å®ç°æ›´å¤šï¼šEventPair, Timer å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch05-04-futex-object.html"><strong aria-hidden="true">5.4.</strong> ğŸš§ ç”¨æˆ·æ€åŒæ­¥äº’æ–¥ï¼šFutex å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch06-00-hal.html"><strong aria-hidden="true">6.</strong> ç¡¬ä»¶æŠ½è±¡å±‚</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch06-01-zcore-hal-unix.html"><strong aria-hidden="true">6.1.</strong> âœ… UNIXç¡¬ä»¶æŠ½è±¡å±‚</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">ç®€æ˜ zCore æ•™ç¨‹</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/rcore-os/zCore-Tutorial" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="zircon-ç”¨æˆ·ç¨‹åº"><a class="header" href="#zircon-ç”¨æˆ·ç¨‹åº">Zircon ç”¨æˆ·ç¨‹åº</a></h1>
<h2 id="ç”¨æˆ·æ€å¯åŠ¨æµç¨‹"><a class="header" href="#ç”¨æˆ·æ€å¯åŠ¨æµç¨‹">ç”¨æˆ·æ€å¯åŠ¨æµç¨‹</a></h2>
<h3 id="æµç¨‹æ¦‚è¦"><a class="header" href="#æµç¨‹æ¦‚è¦">æµç¨‹æ¦‚è¦</a></h3>
<p>kernel<br />
-&gt; userboot  (decompress bootsvc LZ4 format)<br />
-&gt; bootsvc   (å¯æ‰§è¡Œæ–‡ä»¶bin/component_manager)<br />
-&gt; component_manager<br />
-&gt; sh / device_manager</p>
<h3 id="zbizircon-boot-image"><a class="header" href="#zbizircon-boot-image">ZBI(Zircon Boot Image)</a></h3>
<p>ZBIæ˜¯ä¸€ç§ç®€å•çš„å®¹å™¨æ ¼å¼ï¼Œå®ƒå†…åµŒäº†è®¸å¤šå¯ç”±å¼•å¯¼åŠ è½½ç¨‹åº <code>BootLoader</code>ä¼ é€’çš„é¡¹ç›®å†…å®¹ï¼ŒåŒ…æ‹¬ç¡¬ä»¶ç‰¹å®šçš„ä¿¡æ¯ã€æä¾›å¼•å¯¼é€‰é¡¹çš„å†…æ ¸â€œå‘½ä»¤è¡Œâ€ä»¥åŠRAMç£ç›˜æ˜ åƒ(é€šå¸¸æ˜¯è¢«å‹ç¼©çš„)ã€‚<code>ZBI</code>ä¸­åŒ…å«äº†åˆå§‹æ–‡ä»¶ç³»ç»Ÿ <code>bootfs</code>ï¼Œå†…æ ¸å°† <code>ZBI</code> å®Œæ•´ä¼ é€’ç»™ <code>userboot</code>ï¼Œç”±å®ƒè´Ÿè´£è§£æå¹¶å¯¹å…¶å®ƒè¿›ç¨‹æä¾›æ–‡ä»¶æœåŠ¡ã€‚</p>
<h3 id="bootfs"><a class="header" href="#bootfs">bootfs</a></h3>
<p>åŸºæœ¬çš„<code>bootfs</code>æ˜ åƒå¯æ»¡è¶³ç”¨æˆ·ç©ºé—´ç¨‹åºè¿è¡Œéœ€è¦çš„æ‰€æœ‰ä¾èµ–:
+ å¯æ‰§è¡Œæ–‡ä»¶
+ å…±äº«åº“
+ æ•°æ®æ–‡ä»¶</p>
<p>ä»¥ä¸Šåˆ—å‡ºçš„å†…å®¹è¿˜å¯å®ç°è®¾å¤‡é©±åŠ¨æˆ–æ›´é«˜çº§çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä»è€Œèƒ½å¤Ÿä»å­˜å‚¨è®¾å¤‡æˆ–ç½‘ç»œè®¾å¤‡ä¸Šè®¿é—®è¯»å–æ›´å¤šçš„ä»£ç å’Œæ•°æ®ã€‚</p>
<p>åœ¨ç³»ç»Ÿè‡ªå¼•å¯¼ç»“æŸåï¼Œ<code>bootfs</code>ä¸­çš„æ–‡ä»¶å°±ä¼šæˆä¸ºä¸€ä¸ªæŒ‚è½½åœ¨æ ¹ç›®å½•<code>/boot</code>ä¸Šçš„åªè¯»æ–‡ä»¶ç³»ç»Ÿæ ‘(å¹¶ç”±bootsvcæä¾›æœåŠ¡)ã€‚éšå<code>userboot</code>å°†ä»<code>bootfs</code>åŠ è½½ç¬¬ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ç”¨æˆ·ç¨‹åºã€‚</p>
<h3 id="a-hrefhttpsfuchsiadevfuchsia-srcconceptsbootingprogram_loadingzcoreç¨‹åºelfåŠ è½½ä¸åŠ¨æ€é“¾æ¥a"><a class="header" href="#a-hrefhttpsfuchsiadevfuchsia-srcconceptsbootingprogram_loadingzcoreç¨‹åºelfåŠ è½½ä¸åŠ¨æ€é“¾æ¥a"><a href="https://fuchsia.dev/fuchsia-src/concepts/booting/program_loading">zCoreç¨‹åº(ELFåŠ è½½ä¸åŠ¨æ€é“¾æ¥)</a></a></h3>
<p>zCoreå†…æ ¸ä¸ç›´æ¥å‚ä¸æ­£å¸¸ç¨‹åºçš„åŠ è½½ï¼Œè€Œæ˜¯æä¾›äº†ä¸€äº›ç”¨æˆ·æ€ç¨‹åºåŠ è½½æ—¶å¯ç”¨çš„æ¨¡å—ã€‚å¦‚è™šæ‹Ÿå†…å­˜å¯¹è±¡(VMO)ã€è¿›ç¨‹(processes)ã€è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆVMARï¼‰å’Œçº¿ç¨‹(threads)ã€‚ </p>
<h3 id="elf-æ ¼å¼ä»¥åŠç³»ç»Ÿåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£system-abi"><a class="header" href="#elf-æ ¼å¼ä»¥åŠç³»ç»Ÿåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£system-abi">ELF æ ¼å¼ä»¥åŠç³»ç»Ÿåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£(system ABI)</a></h3>
<p>æ ‡å‡†çš„zCoreç”¨æˆ·ç©ºé—´ç¯å¢ƒæä¾›äº†åŠ¨æ€é“¾æ¥å™¨ä»¥åŠåŸºäºELFçš„æ‰§è¡Œç¯å¢ƒï¼Œèƒ½å¤Ÿè¿è¡ŒELFæ ¼å¼çš„æ ¼å¼æœºå™¨ç å¯æ‰§è¡Œæ–‡ä»¶ã€‚zCoreè¿›ç¨‹åªèƒ½é€šè¿‡zCore vDSOä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ã€‚å†…æ ¸é‡‡ç”¨åŸºäºELFç³»ç»Ÿå¸¸è§çš„ç¨‹åºäºŒè¿›åˆ¶æ¥å£(ABI)æä¾›äº†vDSOã€‚</p>
<p>å…·å¤‡é€‚å½“åŠŸèƒ½çš„ç”¨æˆ·ç©ºé—´ä»£ç å¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç›´æ¥åˆ›å»ºè¿›ç¨‹å’ŒåŠ è½½ç¨‹åºï¼Œè€Œä¸ç”¨ELFã€‚ä½†æ˜¯zCoreçš„æ ‡å‡†ABIä½¿ç”¨äº†è¿™é‡Œæ‰€è¿°çš„ELFã€‚æœ‰å…³ELFæ–‡ä»¶æ ¼å¼çš„èƒŒæ™¯çŸ¥è¯†å¦‚ä¸‹ï¼š </p>
<h3 id="elfæ–‡ä»¶ç±»å‹"><a class="header" href="#elfæ–‡ä»¶ç±»å‹">ELFæ–‡ä»¶ç±»å‹</a></h3>
<p>â€œET_RELâ€ä»£è¡¨æ­¤ELFæ–‡ä»¶ä¸ºå¯é‡å®šä½æ–‡ä»¶</p>
<p>â€œET_EXECâ€œä»£è¡¨ELFæ–‡ä»¶ä¸ºå¯æ‰§è¡Œæ–‡ä»¶</p>
<p>â€œET_DYNâ€ä»£è¡¨æ­¤ELFæ–‡ä»¶ä¸ºåŠ¨æ€é“¾æ¥åº“</p>
<p>â€œET_COREâ€ä»£è¡¨æ­¤ELFæ–‡ä»¶æ˜¯æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶</p>
<h3 id="ä¼ ç»Ÿelfç¨‹åºæ–‡ä»¶åŠ è½½"><a class="header" href="#ä¼ ç»Ÿelfç¨‹åºæ–‡ä»¶åŠ è½½">ä¼ ç»ŸELFç¨‹åºæ–‡ä»¶åŠ è½½</a></h3>
<p>å¯æ‰§è¡Œé“¾æ¥æ ¼å¼(Executable and Linking Format, ELF)æœ€åˆç”± UNIX ç³»ç»Ÿå®éªŒå®¤å¼€å‘å¹¶å‘å¸ƒï¼Œå¹¶æˆä¸ºå¤§å¤šæ•°ç±»Unixç³»ç»Ÿçš„é€šç”¨æ ‡å‡†å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚åœ¨è¿™äº›ç³»ç»Ÿä¸­ï¼Œå†…æ ¸ä½¿ç”¨<code>POSIX</code>(å¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£)<code>execve API</code>å°†ç¨‹åºåŠ è½½ä¸æ–‡ä»¶ç³»ç»Ÿè®¿é—®é›†æˆåœ¨ä¸€èµ·ã€‚è¯¥ç±»ç³»ç»ŸåŠ è½½ELFç¨‹åºçš„æ–¹å¼ä¼šæœ‰ä¸€äº›ä¸åŒï¼Œä½†å¤§å¤šéµå¾ªä»¥ä¸‹æ¨¡å¼:</p>
<ol>
<li>
<p>å†…æ ¸æŒ‰ç…§åç§°åŠ è½½æ–‡ä»¶ï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯ELFè¿˜æ˜¯ç³»ç»Ÿæ”¯æŒçš„å…¶ä»–ç±»å‹çš„æ–‡ä»¶ã€‚</p>
</li>
<li>
<p>å†…æ ¸æ ¹æ®ELFæ–‡ä»¶çš„<code>PT_LOAD</code>ç¨‹åºå¤´æ¥æ˜ å°„ELFæ˜ åƒã€‚å¯¹äº<code>ET_EXEC</code>æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šå°†ç¨‹åºä¸­çš„å„æ®µ(Section)æ”¾åˆ°<code>p_vaddr</code>ä¸­æ‰€æŒ‡å®šå†…å­˜ä¸­çš„å›ºå®šåœ°å€ã€‚å¯¹äº<code>ET_DYN</code>æ–‡ä»¶ï¼Œç³»ç»Ÿå°†åŠ è½½ç¨‹åºç¬¬ä¸€ä¸ª<code>PT_LOAD</code>çš„åŸºåœ°å€ï¼Œç„¶åæ ¹æ®å®ƒä»¬çš„<code>p_vaddr</code>ç›¸å¯¹äºç¬¬ä¸€ä¸ªsectionçš„<code>p_vaddr</code>æ”¾ç½®åé¢çš„sectionã€‚ é€šå¸¸æ¥è¯´è¯¥åŸºåœ°å€æ˜¯é€šè¿‡åœ°å€éšæœºåŒ–(ASLR)æ¥äº§ç”Ÿçš„ã€‚</p>
</li>
<li>
<p>è‹¥ELFæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª<code>PT_INTERP</code>(Program interpreter)ç¨‹åºå¤´,  å®ƒçš„éƒ¨åˆ†å†…å®¹(ELFæ–‡ä»¶ä¸­<code>p_offset</code>å’Œ<code>p_filesz</code>ç»™å‡ºçš„ä¸€äº›å­—èŠ‚)è¢«å½“åšä¸ºä¸€ä¸ªæ–‡ä»¶åï¼Œæ”¹æ–‡ä»¶åç”¨äºå¯»æ‰¾å¦ä¸€ä¸ªç§°ä¸ºâ€œELFè§£é‡Šå™¨â€çš„ELFæ–‡ä»¶ã€‚ä¸Šè¿°è¿™ç§ELFæ–‡ä»¶æ˜¯<code>ET_DYN</code>æ–‡ä»¶ã€‚å†…æ ¸é‡‡ç”¨åŒæ ·çš„æ–¹å¼å°†è¯¥ç±»ELFæ–‡ä»¶åŠ è½½ï¼Œä½†æ˜¯æ‰€åŠ è½½çš„åœ°å€æ˜¯è‡ªå®šçš„ã€‚è¯¥ELFâ€œè§£é‡Šå™¨â€é€šå¸¸æŒ‡çš„æ˜¯è¢«å‘½åä¸º<code>/lib/ld.so.1</code> æˆ–è€…æ˜¯ <code>/lib/ld-linux.so.2</code>çš„ELFåŠ¨æ€é“¾æ¥å™¨ã€‚</p>
</li>
<li>
<p>å†…æ ¸ä¸ºåˆå§‹çš„çº¿ç¨‹è®¾ç½®äº†å¯„å­˜å™¨å’Œå †æ ˆçš„å†…å®¹ï¼Œå¹¶åœ¨PCå¯„å­˜å™¨å·²æŒ‡å‘ç‰¹å®šç¨‹åºå…¥å£å¤„(Entry Point)çš„æƒ…å†µä¸‹å¯åŠ¨çº¿ç¨‹ã€‚ </p>
<ul>
<li>ç¨‹åºå…¥å£å¤„(Entry Point)æŒ‡çš„æ˜¯ELFæ–‡ä»¶å¤´ä¸­ <code>e_entry</code>çš„å€¼ï¼Œå®ƒä¼šæ ¹æ®ç¨‹åºåŸºåœ°å€(base address)åšç›¸åº”çš„è°ƒæ•´ã€‚å¦‚æœè¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰<code>PT_INTERP</code>çš„ELFæ–‡ä»¶ï¼Œåˆ™å®ƒçš„å…¥å£ç‚¹ä¸åœ¨å®ƒæœ¬èº«ï¼Œè€Œæ˜¯è¢«è®¾ç½®åœ¨åŠ¨æ€é“¾æ¥å™¨ä¸­ã€‚</li>
<li>å†…æ ¸é€šè¿‡è®¾ç½®å¯„å­˜å™¨å’Œå †æ ˆæ¥ä½¿å¾—ç¨‹åºèƒ½å¤Ÿæ¥æ”¶ç‰¹å®šçš„å‚æ•°ï¼Œç¯å¢ƒå˜é‡ä»¥åŠå…¶å®ƒæœ‰å®é™…ç”¨é€”çš„è¾…åŠ©å‘é‡ã€‚å¯„å­˜å™¨å’Œå †æ ˆçš„è®¾ç½®æ–¹æ³•éµå¾ªäº†ä¸€ç§æ±‡ç¼–çº§åˆ«çš„åè®®æ–¹å¼ã€‚è‹¥ELFæ–‡ä»¶è¿è¡Œæ—¶ä¾èµ–åŠ¨æ€é“¾æ¥ï¼Œå³å¸¦æœ‰<code>PT_INTERP</code>ã€‚åˆ™å¯„å­˜å™¨å’Œå †æ ˆä¸­å°†åŒ…æ‹¬æ¥è‡ªè¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ELFæ–‡ä»¶å¤´ä¸­çš„åŸºåœ°å€ã€å…¥å£ç‚¹å’Œç¨‹åºå¤´éƒ¨è¡¨åœ°å€ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯å…è®¸åŠ¨æ€é“¾æ¥å™¨åœ¨å†…å­˜ä¸­æ‰¾åˆ°è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ELFåŠ¨æ€é“¾æ¥å…ƒæ•°æ®ï¼Œä»¥å®ç°åŠ¨æ€é“¾æ¥ã€‚å½“åŠ¨æ€é“¾æ¥å¯åŠ¨å®Œæˆåï¼ŒåŠ¨æ€é“¾æ¥å™¨å°†è·³è½¬åˆ°è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ç‚¹åœ°å€ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub fn sys_process_start(
        &amp;self,
        proc_handle: HandleValue,
        thread_handle: HandleValue,
        entry: usize,
        stack: usize,
        arg1_handle: HandleValue,
        arg2: usize,
    ) -&gt; ZxResult {
        info!(&quot;process.start: proc_handle={:?}, thread_handle={:?}, entry={:?}, stack={:?}, arg1_handle={:?}, arg2={:?}&quot;,
            proc_handle, thread_handle, entry, stack, arg1_handle, arg2
        );
        let proc = self.thread.proc();
        let process = proc.get_object_with_rights::&lt;Process&gt;(proc_handle, Rights::WRITE)?;
        let thread = proc.get_object_with_rights::&lt;Thread&gt;(thread_handle, Rights::WRITE)?;
        if !Arc::ptr_eq(&amp;thread.proc(), &amp;process) {
            return Err(ZxError::ACCESS_DENIED);
        }
        let arg1 = if arg1_handle != INVALID_HANDLE {
            let arg1 = proc.remove_handle(arg1_handle)?;
            if !arg1.rights.contains(Rights::TRANSFER) {
                return Err(ZxError::ACCESS_DENIED);
            }
            Some(arg1)
        } else {
            None
        };
        process.start(&amp;thread, entry, stack, arg1, arg2, self.spawn_fn)?;
        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
</li>
</ol>
<p>zCoreçš„ç¨‹åºåŠ è½½å—åˆ°äº†ä¼ ç»Ÿæ–¹å¼çš„å¯å‘ï¼Œä½†æ˜¯æœ‰ä¸€äº›ä¸åŒã€‚åœ¨ä¼ ç»Ÿæ¨¡å¼ä¸­ï¼Œéœ€è¦åœ¨åŠ è½½åŠ¨æ€é“¾æ¥å™¨ä¹‹å‰åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€ä¸ªå…³é”®åŸå› æ˜¯ï¼ŒåŠ¨æ€é“¾æ¥å™¨éšæœºåŒ–é€‰æ‹©çš„åŸºåœ°å€(base address)ä¸èƒ½ä¸<code>ET_EXEC</code>å¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨çš„å›ºå®šåœ°å€ç›¸äº¤ã€‚zCoreä»æ ¹æœ¬ä¸Šå¹¶ä¸æ”¯æŒ<code>ET_EXEC</code>æ ¼å¼ELFæ–‡ä»¶çš„å›ºå®šåœ°å€ç¨‹åºåŠ è½½ï¼Œå®ƒåªæ”¯æŒä½ç½®æ— å…³çš„å¯æ‰§è¡Œæ–‡ä»¶æˆ–<a href="https://patchwork.kernel.org/patch/9807325/">PIE</a>(<code>ET_DYN</code>æ ¼å¼çš„ELFæ–‡ä»¶)</p>
<h3 id="vmarext-traitå®ç°"><a class="header" href="#vmarext-traitå®ç°">VmarExt traitå®ç°</a></h3>
<p>zCoreåº•å±‚çš„APIä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿã€‚zCoreç¨‹åºæ–‡ä»¶çš„åŠ è½½é€šè¿‡è™šæ‹Ÿå†…å­˜å¯¹è±¡(VMO)ä»¥åŠ<code>channel</code>ä½¿ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶æ¥å®Œæˆã€‚</p>
<p>ç¨‹åºçš„åŠ è½½åŸºäºå¦‚ä¸‹ä¸€äº›å‰æï¼š
+ è·å¾—ä¸€ä¸ªåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„è™šæ‹Ÿå†…å­˜å¯¹è±¡ï¼ˆVMOï¼‰çš„å¥æŸ„ã€‚</p>
<blockquote>
<p>zircon-object\src\util\elf_loader.rs</p>
</blockquote>
<pre><code class="language-shell">fn make_vmo(elf: &amp;ElfFile, ph: ProgramHeader) -&gt; ZxResult&lt;Arc&lt;VmObject&gt;&gt; {
    assert_eq!(ph.get_type().unwrap(), Type::Load);
    let page_offset = ph.virtual_addr() as usize % PAGE_SIZE;
    let pages = pages(ph.mem_size() as usize + page_offset);
    let vmo = VmObject::new_paged(pages);
    let data = match ph.get_data(&amp;elf).unwrap() {
        SegmentData::Undefined(data) =&gt; data,
        _ =&gt; return Err(ZxError::INVALID_ARGS),
    };
    vmo.write(page_offset, data)?;
    Ok(vmo)
}
</code></pre>
<ul>
<li>ç¨‹åºæ‰§è¡Œå‚æ•°åˆ—è¡¨ã€‚</li>
<li>ç¨‹åºæ‰§è¡Œç¯å¢ƒå˜é‡åˆ—è¡¨ã€‚</li>
<li>å­˜åœ¨ä¸€ä¸ªåˆå§‹çš„å¥æŸ„åˆ—è¡¨ï¼Œæ¯ä¸ªå¥æŸ„éƒ½æœ‰ä¸€ä¸ªå¥æŸ„ä¿¡æ¯é¡¹ã€‚</li>
</ul>
<h3 id="userboot"><a class="header" href="#userboot">USERBOOT</a></h3>
<h4 id="ä½¿ç”¨userbootçš„åŸå› "><a class="header" href="#ä½¿ç”¨userbootçš„åŸå› ">ä½¿ç”¨userbootçš„åŸå› </a></h4>
<p>åœ¨Zirconä¸­ï¼Œå†…åµŒåœ¨ZBIä¸­çš„<code>RAMç£ç›˜æ˜ åƒ</code>é€šå¸¸é‡‡ç”¨<a href="https://github.com/lz4/lz4">LZ4</a>æ ¼å¼å‹ç¼©ã€‚è§£å‹åå°†ç»§ç»­å¾—åˆ°<code>bootfs</code>æ ¼å¼çš„ç£ç›˜é•œåƒã€‚è¿™æ˜¯ä¸€ç§ç®€å•çš„åªè¯»æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ï¼Œå®ƒåªåˆ—å‡ºæ–‡ä»¶åã€‚ä¸”å¯¹äºæ¯ä¸ªæ–‡ä»¶ï¼Œå¯åˆ†åˆ«åˆ—å‡ºå®ƒä»¬åœ¨BOOTFSæ˜ åƒä¸­çš„åç§»é‡å’Œå¤§å°(è¿™ä¸¤ä¸ªå€¼éƒ½å¿…é¡»æ˜¯é¡µé¢å¯¹é½çš„ï¼Œå¹¶ä¸”é™åˆ¶åœ¨32ä½)ã€‚</p>
<p>ç”±äºkernelä¸­æ²¡æœ‰åŒ…å«ä»»ä½•å¯ç”¨äºè§£å‹ç¼©<a href="https://github.com/lz4/lz4">LZ4</a>æ ¼å¼çš„ä»£ç ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç”¨äºè§£æBOOTFSæ ¼å¼çš„ä»£ç ã€‚æ‰€æœ‰è¿™äº›å·¥ä½œéƒ½æ˜¯ç”±ç§°ä¸º<code>userboot</code>çš„ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹å®Œæˆçš„ã€‚</p>
<blockquote>
<p>zCoreä¸­æœªæ‰¾åˆ°è§£å‹ç¼©bootfsçš„ç›¸å…³å®ç°ï¼Œ<br />
ä½†æ˜¯èƒ½å¤Ÿåœ¨scripts/gen-prebuilt.shä¸­æ‰¾åˆ°ZBIä¸­ç¡®å®æœ‰bootfsçš„å†…å®¹<br />
ä¸”ç°æœ‰çš„zCoreå®ç°ä¸­æœ‰å…³æ‰€è½½å…¥çš„ZBIæ–¹å¼å¦‚ä¸‹ï¼š</p>
</blockquote>
<blockquote>
<p>zircon-loader/src/lib.rs</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    // zbi
    let zbi_vmo = {
        let vmo = VmObject::new_paged(images.zbi.as_ref().len() / PAGE_SIZE + 1);
        vmo.write(0, images.zbi.as_ref()).unwrap();
        vmo.set_name(&quot;zbi&quot;);
        vmo
    };
<span class="boring">}
</span></code></pre></pre>
<h4 id="userbootæ˜¯ä»€ä¹ˆ"><a class="header" href="#userbootæ˜¯ä»€ä¹ˆ">userbootæ˜¯ä»€ä¹ˆ</a></h4>
<p>userbootæ˜¯ä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·ç©ºé—´è¿›ç¨‹ã€‚å®ƒåªèƒ½åƒä»»ä½•å…¶ä»–è¿›ç¨‹ä¸€æ ·é€šè¿‡vDSOæ‰§è¡Œæ ‡å‡†çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶å—å®Œæ•´vDSOæ‰§è¡Œåˆ¶åº¦çš„çº¦æŸã€‚</p>
<blockquote>
<p>å”¯ä¸€ä¸€ä¸ªç”±å†…æ ¸æ€â€œä¸è§„èŒƒåœ°â€åˆ›å»ºçš„ç”¨æˆ·è¿›ç¨‹</p>
<p>userbootå…·ä½“å®ç°çš„åŠŸèƒ½æœ‰ï¼š</p>
<ul>
<li>
<p>è¯»å–channelä¸­çš„cmdlineã€handles </p>
</li>
<li>
<p>è§£æzbi</p>
</li>
<li>
<p>è§£å‹BOOTFS </p>
</li>
<li>
<p>é€‰å®šä¸‹ä¸€ä¸ªç¨‹åºå¯åŠ¨ è‡ªå·±å……å½“loaderï¼Œç„¶åâ€œæ­»äº¡â€</p>
</li>
<li>
<p>ç”¨â€œè§„èŒƒçš„æ–¹å¼â€å¯åŠ¨ä¸‹ä¸€ä¸ªç¨‹åº</p>
</li>
</ul>
</blockquote>
<p>userbootè¢«æ„å»ºä¸ºä¸€ä¸ªELFåŠ¨æ€å…±äº«å¯¹è±¡(DSO,dynamic shared object)ï¼Œä½¿ç”¨äº†ä¸vDSOç›¸åŒçš„å¸ƒå±€ã€‚ä¸vDSOä¸€æ ·ï¼Œuserbootçš„ELFæ˜ åƒåœ¨ç¼–è¯‘æ—¶å°±è¢«åµŒå…¥åˆ°å†…æ ¸ä¸­ã€‚å…¶ç®€å•çš„å¸ƒå±€æ„å‘³ç€åŠ è½½å®ƒä¸éœ€è¦å†…æ ¸åœ¨å¼•å¯¼æ—¶è§£æELFçš„æ–‡ä»¶å¤´ã€‚å†…æ ¸åªéœ€è¦çŸ¥é“ä¸‰ä»¶äº‹:</p>
<ol>
<li>åªè¯»æ®µ<code>segment</code>çš„å¤§å°</li>
<li>å¯æ‰§è¡Œæ®µ<code>segment</code>çš„å¤§å°</li>
<li><code>userboot</code>å…¥å£ç‚¹çš„åœ°å€ã€‚</li>
</ol>
<p>è¿™äº›å€¼åœ¨ç¼–è¯‘æ—¶ä¾¿å¯ä»userboot ELFæ˜ åƒä¸­æå–ï¼Œå¹¶åœ¨å†…æ ¸ä»£ç ä¸­ç”¨ä½œå¸¸é‡ã€‚</p>
<h4 id="kernelå¦‚ä½•å¯ç”¨userboot"><a class="header" href="#kernelå¦‚ä½•å¯ç”¨userboot">kernelå¦‚ä½•å¯ç”¨userboot</a></h4>
<p>ä¸ä»»ä½•å…¶ä»–è¿›ç¨‹ä¸€æ ·ï¼Œuserbootå¿…é¡»ä»å·²ç»æ˜ å°„åˆ°å…¶åœ°å€ç©ºé—´çš„vDSOå¼€å§‹ï¼Œè¿™æ ·å®ƒæ‰èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å†…æ ¸å°†userbootå’ŒvDSOæ˜ å°„åˆ°ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œç„¶ååœ¨userbootçš„å…¥å£å¤„å¯åŠ¨å®ƒã€‚</p>
<!-- > !  userbootçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒçš„åŠ è½½æ–¹å¼ã€‚   
> ...todo -->
<h4 id="userbootå¦‚ä½•åœ¨vdsoä¸­å–å¾—ç³»ç»Ÿè°ƒç”¨"><a class="header" href="#userbootå¦‚ä½•åœ¨vdsoä¸­å–å¾—ç³»ç»Ÿè°ƒç”¨">userbootå¦‚ä½•åœ¨vDSOä¸­å–å¾—ç³»ç»Ÿè°ƒç”¨</a></h4>
<p>å½“å†…æ ¸å°†<code>userboot</code>æ˜ å°„åˆ°ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹æ—¶ï¼Œä¼šåƒæ­£å¸¸ç¨‹åºé‚£æ ·ï¼Œåœ¨å†…å­˜ä¸­é€‰æ‹©ä¸€ä¸ªéšæœºåœ°å€è¿›è¡ŒåŠ è½½ã€‚è€Œåœ¨æ˜ å°„<code>userboot</code>çš„vDSOæ—¶ï¼Œå¹¶ä¸é‡‡ç”¨ä¸Šè¿°éšæœºçš„æ–¹å¼ï¼Œè€Œæ˜¯å°†vDSOæ˜ åƒç›´æ¥æ”¾åœ¨å†…å­˜ä¸­<code>userboot</code>çš„æ˜ åƒä¹‹åã€‚è¿™æ ·ä¸€æ¥ï¼ŒvDSOä»£ç ä¸<code>userboot</code>çš„åç§»é‡æ€»æ˜¯å›ºå®šçš„ã€‚</p>
<p>åœ¨ç¼–è¯‘é˜¶æ®µä¸­ï¼Œç³»ç»Ÿè°ƒç”¨çš„å…¥å£ç‚¹ç¬¦å·è¡¨ä¼šä»vDSO ELFæ˜ åƒä¸­æå–å‡ºæ¥ï¼Œéšåå†™å…¥åˆ°é“¾æ¥è„šæœ¬çš„ç¬¦å·å®šä¹‰ä¸­ã€‚åˆ©ç”¨æ¯ä¸ªç¬¦å·åœ¨vDSOæ˜ åƒä¸­ç›¸å¯¹å›ºå®šçš„åç§»åœ°å€ï¼Œå¯åœ¨é“¾æ¥è„šæœ¬æä¾›çš„<code>_end</code>ç¬¦å·çš„å›ºå®šåç§»é‡å¤„ï¼Œå®šä¹‰è¯¥ç¬¦å·ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œuserbootä»£ç å¯ä»¥ç›´æ¥è°ƒç”¨åˆ°æ”¾åœ¨å†…å­˜ä¸­ï¼Œå…¶æ˜ åƒæœ¬èº«ä¹‹åçš„ï¼Œæ¯ä¸ªç¡®åˆ‡ä½ç½®ä¸Šçš„vDSOå…¥å£ç‚¹ã€‚</p>
<p>ç›¸å…³ä»£ç :</p>
<blockquote>
<p>zircon-loader/src/lib.rs</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn run_userboot(images: &amp;Images&lt;impl AsRef&lt;[u8]&gt;&gt;, cmdline: &amp;str) -&gt; Arc&lt;Process&gt; {
    ...
    // vdso
    let vdso_vmo = {
        let elf = ElfFile::new(images.vdso.as_ref()).unwrap();
        let vdso_vmo = VmObject::new_paged(images.vdso.as_ref().len() / PAGE_SIZE + 1);
        vdso_vmo.write(0, images.vdso.as_ref()).unwrap();
        let size = elf.load_segment_size();
        let vmar = vmar
            .allocate_at(
                userboot_size,
                size,
                VmarFlags::CAN_MAP_RXW | VmarFlags::SPECIFIC,
                PAGE_SIZE,
            )
            .unwrap();
        vmar.map_from_elf(&amp;elf, vdso_vmo.clone()).unwrap();
        #[cfg(feature = &quot;std&quot;)]
        {
            let offset = elf
                .get_symbol_address(&quot;zcore_syscall_entry&quot;)
                .expect(&quot;failed to locate syscall entry&quot;) as usize;
            let syscall_entry = &amp;(kernel_hal_unix::syscall_entry as usize).to_ne_bytes();
            // fill syscall entry x3
            vdso_vmo.write(offset, syscall_entry).unwrap();
            vdso_vmo.write(offset + 8, syscall_entry).unwrap();
            vdso_vmo.write(offset + 16, syscall_entry).unwrap();
        }
        vdso_vmo
    };
    ...

}
<span class="boring">}
</span></code></pre></pre>
<h3 id="bootsvc"><a class="header" href="#bootsvc">bootsvc</a></h3>
<p>bootsvc é€šå¸¸æ˜¯usermodeåŠ è½½çš„ç¬¬ä¸€ä¸ªç¨‹åºï¼ˆä¸userbootä¸åŒï¼Œuserbootæ˜¯ç”±å†…æ ¸åŠ è½½çš„ï¼‰ã€‚bootsvcæä¾›äº†å‡ ç§ç³»ç»ŸæœåŠ¡ï¼š</p>
<ul>
<li>
<p>åŒ…å«bootfsï¼ˆ/bootï¼‰å†…å®¹çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡ï¼ˆåˆå§‹çš„bootfsæ˜ åƒåŒ…å«ç”¨æˆ·ç©ºé—´ç³»ç»Ÿéœ€è¦è¿è¡Œçš„æ‰€æœ‰å†…å®¹:</p>
<ul>
<li>å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>å…±äº«åº“å’Œæ•°æ®æ–‡ä»¶ï¼ˆåŒ…æ‹¬è®¾å¤‡é©±åŠ¨ç¨‹åºæˆ–æ›´é«˜çº§çš„æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ï¼‰</li>
</ul>
</li>
<li>
<p>ä»bootfsåŠ è½½çš„åŠ è½½ç¨‹åºæœåŠ¡</p>
</li>
<li>
<p>bin/component_manager</p>
</li>
<li>
<p>sh / device_manager</p>
</li>
</ul>
<h2 id="ç”¨æˆ·ç¨‹åºçš„ç»„æˆ"><a class="header" href="#ç”¨æˆ·ç¨‹åºçš„ç»„æˆ">ç”¨æˆ·ç¨‹åºçš„ç»„æˆ</a></h2>
<blockquote>
<p>å†…æ ¸ä¸ç›´æ¥å‚ä¸ç”¨æˆ·ç¨‹åºçš„åŠ è½½å·¥ä½œï¼ˆç¬¬ä¸€ä¸ªè¿›ç¨‹é™¤å¤–ï¼‰</p>
<p>ç”¨æˆ·ç¨‹åºå¼ºåˆ¶ä½¿ç”¨ PIC å’Œ PIEï¼ˆä½ç½®æ— å…³ä»£ç ï¼‰</p>
<p>å†…å­˜åœ°å€ç©ºé—´ç»„æˆï¼šProgram, Stack, vDSO, Dylibs</p>
<p>é€šè¿‡ Channel ä¼ é€’å¯åŠ¨ä¿¡æ¯å’Œå¥æŸ„</p>
</blockquote>
<h2 id="ç³»ç»Ÿè°ƒç”¨çš„è·³æ¿vdso"><a class="header" href="#ç³»ç»Ÿè°ƒç”¨çš„è·³æ¿vdso">ç³»ç»Ÿè°ƒç”¨çš„è·³æ¿ï¼švDSO</a></h2>
<h4 id="ä»‹ç»-vdso-çš„ä½œç”¨"><a class="header" href="#ä»‹ç»-vdso-çš„ä½œç”¨">ä»‹ç» vDSO çš„ä½œç”¨</a></h4>
<p>vDSOï¼ˆvirtual Dynamic Shared Objectï¼‰ï¼ŒZircon vDSO æ˜¯ Zircon å†…æ ¸è®¿é—®ç³»ç»Ÿè°ƒç”¨çš„å”¯ä¸€æ–¹æ³•(ä½œä¸ºç³»ç»Ÿè°ƒç”¨çš„è·³æ¿)ã€‚å®ƒä¹‹æ‰€ä»¥æ˜¯è™šæ‹Ÿçš„ï¼Œæ˜¯å› ä¸ºå®ƒä¸æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿä¸­çš„ELFæ–‡ä»¶åŠ è½½çš„ï¼Œè€Œæ˜¯ç”±å†…æ ¸ç›´æ¥æä¾›çš„vDSOé•œåƒã€‚</p>
<!-- Zircon vDSOæ˜¯è®¿é—®Zirconç³»ç»Ÿè°ƒç”¨çš„å”¯ä¸€æ‰‹æ®µã€‚vDSOè¡¨ç¤ºè™šæ‹ŸåŠ¨æ€å…±äº«å¯¹è±¡ã€‚(åŠ¨æ€å…±äº«å¯¹è±¡æ˜¯ä¸€ä¸ªæœ¯è¯­ï¼Œç”¨äºELFæ ¼å¼çš„å…±äº«åº“ã€‚)å®ƒæ˜¯è™šæ‹Ÿçš„ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿä¸­çš„ELFæ–‡ä»¶åŠ è½½çš„ã€‚ç›¸åï¼ŒvDSOæ˜ åƒç”±å†…æ ¸ç›´æ¥æä¾›ã€‚ -->
<blockquote>
<p>zCore/src/main.rs</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2018">#[cfg(feature = &quot;zircon&quot;)]
fn main(ramfs_data: &amp;[u8], cmdline: &amp;str) {
    use zircon_loader::{run_userboot, Images};
    let images = Images::&lt;&amp;[u8]&gt; {
        userboot: include_bytes!(&quot;../../prebuilt/zircon/x64/userboot.so&quot;),
        vdso: include_bytes!(&quot;../../prebuilt/zircon/x64/libzircon.so&quot;),
        zbi: ramfs_data,
    };
    let _proc = run_userboot(&amp;images, cmdline);
    run();
}
</code></pre></pre>
<p>å®ƒæ˜¯ä¸€ä¸ªç”¨æˆ·æ€è¿è¡Œçš„ä»£ç ï¼Œè¢«å°è£…æˆ<code>prebuilt/zircon/x64/libzircon.so</code>æ–‡ä»¶ã€‚è¿™ä¸ª.so æ–‡ä»¶è£…è½½ä¸æ˜¯æ”¾åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè€Œæ˜¯ç”±å†…æ ¸æä¾›ã€‚å®ƒè¢«æ•´åˆåœ¨å†…æ ¸imageä¸­ã€‚</p>
<p>vDSOæ˜ åƒåœ¨ç¼–è¯‘æ—¶åµŒå…¥åˆ°å†…æ ¸ä¸­ã€‚å†…æ ¸å°†å®ƒä½œä¸ºåªè¯»VMOå…¬å¼€ç»™ç”¨æˆ·ç©ºé—´ã€‚å†…æ ¸å¯åŠ¨æ—¶ï¼Œä¼šé€šè¿‡è®¡ç®—å¾—åˆ°å®ƒæ‰€åœ¨çš„ç‰©ç†é¡µã€‚å½“<code>program loader</code>è®¾ç½®äº†ä¸€ä¸ªæ–°è¿›ç¨‹åï¼Œä½¿è¯¥è¿›ç¨‹èƒ½å¤Ÿè¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„å”¯ä¸€æ–¹æ³•æ˜¯ï¼š<code>program loader</code>åœ¨æ–°è¿›ç¨‹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹å¼€å§‹è¿è¡Œä¹‹å‰ï¼Œå°†vDSOæ˜ å°„åˆ°æ–°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆåœ°å€éšæœºï¼‰ã€‚å› æ­¤ï¼Œåœ¨å¯åŠ¨å…¶ä»–èƒ½å¤Ÿè¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹çš„æ¯ä¸ªè¿›ç¨‹è‡ªå·±æœ¬èº«éƒ½å¿…é¡»èƒ½å¤Ÿè®¿é—®vDSOçš„VMOã€‚</p>
<blockquote>
<p>zircon-loader/src/lib.rs#line167</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    proc.start(&amp;thread, entry, sp, Some(handle), 0, thread_fn)
        .expect(&quot;failed to start main thread&quot;);
    proc
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>zircon-object/src/task/process.rs#line189</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    thread.start(entry, stack, handle_value as usize, arg2, thread_fn)
<span class="boring">}
</span></code></pre></pre>
<p>vDSOè¢«æ˜ å°„åˆ°æ–°è¿›ç¨‹çš„åŒæ—¶ä¼šå°†æ˜ åƒçš„<code>base address</code>é€šè¿‡<code>arg2</code>å‚æ•°ä¼ é€’ç»™æ–°è¿›ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ã€‚é€šè¿‡è¿™ä¸ªåœ°å€ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­æ‰¾åˆ°ELFçš„æ–‡ä»¶å¤´ï¼Œè¯¥æ–‡ä»¶å¤´æŒ‡å‘å¯ç”¨äºæŸ¥æ‰¾ç³»ç»Ÿè°ƒç”¨ç¬¦å·åçš„å…¶ä»–ELFç¨‹åºæ¨¡å—ã€‚</p>
<h4 id="å¦‚ä½•ä¿®æ”¹-vdso-æºç libzirconå°†-syscall-æ”¹ä¸ºå‡½æ•°è°ƒç”¨"><a class="header" href="#å¦‚ä½•ä¿®æ”¹-vdso-æºç libzirconå°†-syscall-æ”¹ä¸ºå‡½æ•°è°ƒç”¨">å¦‚ä½•ä¿®æ”¹ vDSO æºç ï¼ˆlibzirconï¼‰å°† syscall æ”¹ä¸ºå‡½æ•°è°ƒç”¨</a></h4>
<h5 id="æœ‰å…³ä»£ç "><a class="header" href="#æœ‰å…³ä»£ç ">æœ‰å…³ä»£ç </a></h5>
<ul>
<li>å‚è€ƒä»“åº“<a href="https://github.com/PanQL/zircon/blob/master/README.md">README.MD</a>
<blockquote>
<p>Â·Â·Â·è§£æä»£ç ä¾èµ–çš„compile_commands.jsonå°†ä¼šéšbuildè¿‡ç¨‹ç”Ÿæˆåˆ°<strong>out</strong>æ–‡ä»¶å¤¹Â·Â·Â·</p>
</blockquote>
</li>
</ul>
<h5 id="å¦‚ä½•ç”Ÿæˆimgsvdsozbi"><a class="header" href="#å¦‚ä½•ç”Ÿæˆimgsvdsozbi">å¦‚ä½•ç”Ÿæˆimgs(VDSO,ZBI)</a></h5>
<ol>
<li>
<p>clone Zirconä»£ç ä»“åº“ï¼ˆä»fuchsiaå®˜æ–¹ç›®å½•ä¸­åˆ†ç¦»å‡ºæ¥çš„zirconä»£ç ï¼‰ï¼š</p>
<pre><code class="language-shell">$ git clone https://github.com/PanQL/zircon.git
</code></pre>
</li>
<li>
<p>å…³äºZirconçš„ç¼–è¯‘è¿è¡Œ<br />
ä¸ºäº†å‡å°ä»“åº“ä½“ç§¯ï¼Œæˆ‘ä»¬å°†prebuiltç›®å½•è¿›è¡Œäº†å¤§å¹…è°ƒæ•´;å› æ­¤è¿è¡Œä¹‹å‰è¯·ä¸‹è½½googleé¢„ç¼–è¯‘å¥½çš„clangï¼Œè§£å‹åæ”¾åˆ°æŸä¸ªæƒé™åˆé€‚çš„ä½ç½®ï¼Œç„¶ååœ¨ä»£ç çš„<a href="https://github.com/PanQL/zircon/blob/master/public/gn/toolchain/clang.gni#L16">è¿™ä¸ªä½ç½®</a>å°†<strong>ç»å¯¹ç›®å½•</strong>ä¿®æ”¹ä¸ºå¯¹åº”ä½ç½®ã€‚ 
clangä¸‹è½½é“¾æ¥:</p>
<ul>
<li><a href="https://cloud.tsinghua.edu.cn/d/7ab1d87feecd4b2cb3d8/">äº‘ç›˜ä¸‹è½½é“¾æ¥</a></li>
<li>å®˜æ–¹CIPDåŒ…ä¸‹è½½é“¾æ¥å¦‚ä¸‹
<ul>
<li><a href="https://chrome-infra-packages.appspot.com/p/fuchsia/clang/linux-amd64/+/oEsFSe99FkcDKVxZkAY0MKi6C-yYOan1m-QL45N33W8C">Linux</a></li>
<li><a href="https://chrome-infra-packages.appspot.com/p/fuchsia/clang/mac-amd64/+/Lc64-GTi4kihzkCnW8Vaa80TWTnMpZY0Fy6AqChmqvcC">Mac</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>å½“å‰åªæ”¯æŒåœ¨Mac OSåŠLinux x64ä¸Šè¿›è¡Œç¼–è¯‘ã€‚<br />
é»˜è®¤çš„<code>make run</code>å’Œ<code>make build</code>æ˜¯é’ˆå¯¹x64æ¶æ„çš„ï¼Œå¦‚æœå¸Œæœ›ç¼–è¯‘è¿è¡Œarmæ¶æ„çš„zirconï¼Œé‚£ä¹ˆéœ€è¦ï¼š</p>
<ul>
<li>ä¿®æ”¹out/args.gnä¸­çš„<code>legacy-image-x64</code>ä¸º<code>legacy-image-arm64</code></li>
<li>é‡æ–°<code>make build</code></li>
<li><code>make runarm</code></li>
</ul>
</li>
<li>
<p>é…åˆzCoreä¸­çš„æœ‰å…³è„šæœ¬ä¸è¡¥ä¸æ–‡ä»¶</p>
<ul>
<li>scripts/gen-prebuilt.sh</li>
<li>scripts/zircon-libos.patch</li>
</ul>
<ul>
<li>https://github.com/PanQL/zircon/blob/master/system/ulib/zircon/syscall-entry.h</li>
<li>https://github.com/PanQL/zircon/blob/master/system/ulib/zircon/syscalls-x86-64.S</li>
<li>zircon-loader/src/lib.rs#line 83-93</li>
</ul>
</li>
</ol>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        #[cfg(feature = &quot;std&quot;)]
        {
            let offset = elf
                .get_symbol_address(&quot;zcore_syscall_entry&quot;)
                .expect(&quot;failed to locate syscall entry&quot;) as usize;
            let syscall_entry = &amp;(kernel_hal_unix::syscall_entry as usize).to_ne_bytes();
            // fill syscall entry x3
            vdso_vmo.write(offset, syscall_entry).unwrap();
            vdso_vmo.write(offset + 8, syscall_entry).unwrap();
            vdso_vmo.write(offset + 16, syscall_entry).unwrap();
        }

<span class="boring">}
</span></code></pre></pre>
<!-- å½“vsdo ç”¨svc æŒ‡ä»¤åï¼Œè¿™æ—¶CPU exceptionè¿›å…¥å†…æ ¸ï¼Œåˆ° expections.S ä¸­çš„ sync_exception å®ï¼ˆä¸åŒELxï¼Œ sync_exceptionçš„å‚æ•°ä¸ä¸€æ ·ï¼‰ã€‚ç„¶åè¿™ä¸ª sync_exception å®ä¸­å…ˆåšä¸€äº›ç°åœºä¿å­˜çš„å·¥ä½œï¼Œ ç„¶åjumpåˆ° arm64_syscall_dispatcher å®ã€‚

è¿›å…¥arm64_syscall_dispatcherå®åï¼Œ å…ˆåšä¸€äº›syscall numberæ£€æŸ¥ï¼Œç„¶åsyscall number è·³åˆ° call_wrapper_table å‡½æ•°è¡¨ä¸­ç›¸åº”indexé¡¹çš„å‡½æ•°ä¸­å»ï¼ˆcall_wrapper_table åƒä¸€ä¸ªä¸€ç»´çš„å‡½æ•°æŒ‡é’ˆçš„æ•°ç»„ï¼Œsyscall number ä½œindexï¼Œjumpåˆ°ç›¸åº”çš„wrapper syscall function å‡½æ•°ä¸­å»ï¼‰ã€‚ -->
<h4 id="åŠ è½½-vdso-æ—¶ä¿®æ”¹-vdso-ä»£ç æ®µå¡«å…¥è·³è½¬åœ°å€"><a class="header" href="#åŠ è½½-vdso-æ—¶ä¿®æ”¹-vdso-ä»£ç æ®µå¡«å…¥è·³è½¬åœ°å€">åŠ è½½ vDSO æ—¶ä¿®æ”¹ vDSO ä»£ç æ®µï¼Œå¡«å…¥è·³è½¬åœ°å€</a></h4>
<h2 id="ç¬¬ä¸€ä¸ªç”¨æˆ·ç¨‹åºuserboot"><a class="header" href="#ç¬¬ä¸€ä¸ªç”¨æˆ·ç¨‹åºuserboot">ç¬¬ä¸€ä¸ªç”¨æˆ·ç¨‹åºï¼šuserboot</a></h2>
<blockquote>
<p>å®ç° zircon-loader ä¸­çš„ run_userboot å‡½æ•°</p>
<p>èƒ½å¤Ÿè¿›å…¥ç”¨æˆ·æ€å¹¶åœ¨ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶è·³è½¬å›æ¥</p>
</blockquote>
<h4 id="ä»bootfsåŠ è½½ç¬¬ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ç”¨æˆ·ç¨‹åº"><a class="header" href="#ä»bootfsåŠ è½½ç¬¬ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ç”¨æˆ·ç¨‹åº">ä»<code>bootfs</code>åŠ è½½ç¬¬ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ç”¨æˆ·ç¨‹åºã€‚</a></h4>
<p>ä¸»è¦ç›¸å…³ä»£ç ï¼š</p>
<blockquote>
<p>zircon-loader/src/lib.rs
zircon-object/src/util/elf_loader.rs</p>
</blockquote>
<p>å½“<code>userboot</code>è§£å‹å®Œæ¯•<code>ZBI</code>ä¸­çš„<code>bootfs</code>åï¼Œ<code>userboot</code>å°†ç»§ç»­ä»<code>bootfs</code>è½½å…¥ç¨‹åºæ–‡ä»¶è¿è¡Œã€‚</p>
<p>Zirconä¸­å…·ä½“çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p><code>userboot</code>æ£€æŸ¥ä»å†…æ ¸æ¥æ”¶åˆ°çš„ç¯å¢ƒå­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä»£è¡¨äº†ä¸€å®šçš„å†…æ ¸å‘½ä»¤è¡Œã€‚</p>
<blockquote>
<p>zircon-loader/src/main.rs</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2018">#[async_std::main]
async fn main() {
    kernel_hal_unix::init();
    init_logger();

    let opt = Opt::from_args();
    let images = open_images(&amp;opt.prebuilt_path).expect(&quot;failed to read file&quot;);

    let proc: Arc&lt;dyn KernelObject&gt; = run_userboot(&amp;images, &amp;opt.cmdline);
    drop(images);

    proc.wait_signal(Signal::USER_SIGNAL_0).await;
}
</code></pre></pre>
<p>åœ¨Zirconä¸­ï¼š</p>
<ul>
<li>è‹¥è¯¥å­—ç¬¦ä¸²å†…å®¹ä¸º<code>userboot=file</code>ï¼Œé‚£ä¹ˆè¯¥<code>file</code>å°†ä½œä¸ºç¬¬ä¸€ä¸ªçœŸæ­£çš„ç”¨æˆ·è¿›ç¨‹åŠ è½½ã€‚</li>
<li>è‹¥æ²¡æœ‰è¿™æ ·çš„é€‰é¡¹ï¼Œåˆ™<code>userboot</code>å°†é€‰æ‹©çš„é»˜è®¤æ–‡ä¸º<code>bin/bootsvc</code>ã€‚è¯¥æ–‡ä»¶å¯åœ¨<code>bootfs</code>ä¸­æ‰¾åˆ°ã€‚</li>
</ul>
<p>è€Œåœ¨zCoreçš„å®ç°ä¸­ï¼š</p>
<ul>
<li>..</li>
</ul>
</li>
<li>
<p>ä¸ºäº†åŠ è½½ä¸Šè¿°æ–‡ä»¶ï¼Œuserbootå®ç°äº†ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ELFç¨‹åºåŠ è½½å™¨
<code>zircon_object::util::elf_loader::load_from_elf</code></p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    // userboot
    let (entry, userboot_size) = {
        let elf = ElfFile::new(images.userboot.as_ref()).unwrap();
        let size = elf.load_segment_size();
        let vmar = vmar
            .allocate(None, size, VmarFlags::CAN_MAP_RXW, PAGE_SIZE)
            .unwrap();
        vmar.load_from_elf(&amp;elf).unwrap();
        (vmar.addr() + elf.header.pt2.entry_point() as usize, size)
    };
<span class="boring">}
</span></code></pre></pre>
</li>
<li>
<p>ç„¶åuserbootä»¥éšæœºåœ°å€åŠ è½½vDSOã€‚å®ƒä½¿ç”¨æ ‡å‡†çº¦å®šå¯åŠ¨æ–°è¿›ç¨‹ï¼Œå¹¶ç»™å®ƒä¼ é€’ä¸€ä¸ªchannelå¥æŸ„å’ŒvDSOåŸºå€ã€‚
<code>zircon_object::util::elf_loader::map_from_elf</code></p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="ch04-00-userspace.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="ch04-02-context-switch.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="ch04-00-userspace.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="ch04-02-context-switch.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
                <script src="ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
