<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>âœ… åˆè¯†å†…æ ¸å¯¹è±¡ - ç®€æ˜ zCore æ•™ç¨‹</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">ç®€æ˜ zCore æ•™ç¨‹</a></li><li class="chapter-item expanded affix "><a href="zcore-intro.html">ğŸš§ zCore æ•´ä½“ç»“æ„å’Œè®¾è®¡æ¨¡å¼</a></li><li class="chapter-item expanded affix "><a href="fuchsia.html">ğŸš§ Fuchsia OS å’Œ Zircon å¾®å†…æ ¸</a></li><li class="chapter-item expanded "><a href="ch01-00-object.html"><strong aria-hidden="true">1.</strong> å†…æ ¸å¯¹è±¡</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch01-01-kernel-object.html" class="active"><strong aria-hidden="true">1.1.</strong> âœ… åˆè¯†å†…æ ¸å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch01-02-process-object.html"><strong aria-hidden="true">1.2.</strong> ğŸš§ å¯¹è±¡ç®¡ç†å™¨ï¼šProcess å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch01-03-channel-object.html"><strong aria-hidden="true">1.3.</strong> ğŸš§ å¯¹è±¡ä¼ é€å™¨ï¼šChannel å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch02-00-task.html"><strong aria-hidden="true">2.</strong> ä»»åŠ¡ç®¡ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch02-01-zircon-task.html"><strong aria-hidden="true">2.1.</strong> ğŸš§ Zircon ä»»åŠ¡ç®¡ç†ä½“ç³»</a></li><li class="chapter-item expanded "><a href="ch02-02-process-job-object.html"><strong aria-hidden="true">2.2.</strong> ğŸš§ è¿›ç¨‹ç®¡ç†ï¼šProcess ä¸ Job å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch02-03-thread-object.html"><strong aria-hidden="true">2.3.</strong> ğŸš§ çº¿ç¨‹ç®¡ç†ï¼šThread å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch03-00-memory.html"><strong aria-hidden="true">3.</strong> å†…å­˜ç®¡ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-01-zircon-memory.html"><strong aria-hidden="true">3.1.</strong> ğŸš§ Zircon å†…å­˜ç®¡ç†æ¨¡å‹</a></li><li class="chapter-item expanded "><a href="ch03-02-vmo.html"><strong aria-hidden="true">3.2.</strong> ğŸš§ ç‰©ç†å†…å­˜ï¼šVMO å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch03-03-vmo-paged.html"><strong aria-hidden="true">3.3.</strong> ğŸš§ ç‰©ç†å†…å­˜ï¼šæŒ‰é¡µåˆ†é…çš„ VMO</a></li><li class="chapter-item expanded "><a href="ch03-04-vmar.html"><strong aria-hidden="true">3.4.</strong> ğŸš§ è™šæ‹Ÿå†…å­˜ï¼šVMAR å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch04-00-userspace.html"><strong aria-hidden="true">4.</strong> ç”¨æˆ·ç¨‹åº</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch04-01-user-program.html"><strong aria-hidden="true">4.1.</strong> ğŸš§ Zircon ç”¨æˆ·ç¨‹åº</a></li><li class="chapter-item expanded "><a href="ch04-02-context-switch.html"><strong aria-hidden="true">4.2.</strong> ğŸš§ ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li><li class="chapter-item expanded "><a href="ch04-03-syscall.html"><strong aria-hidden="true">4.3.</strong> ğŸš§ ç³»ç»Ÿè°ƒç”¨</a></li></ol></li><li class="chapter-item expanded "><a href="ch05-00-signal-and-waiting.html"><strong aria-hidden="true">5.</strong> ä¿¡å·å’Œç­‰å¾…</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch05-01-wait-signal.html"><strong aria-hidden="true">5.1.</strong> ğŸš§ ç­‰å¾…å†…æ ¸å¯¹è±¡çš„ä¿¡å·</a></li><li class="chapter-item expanded "><a href="ch05-02-port-object.html"><strong aria-hidden="true">5.2.</strong> ğŸš§ åŒæ—¶ç­‰å¾…å¤šä¸ªä¿¡å·ï¼šPort å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch05-03-more-signal-objects.html"><strong aria-hidden="true">5.3.</strong> ğŸš§ å®ç°æ›´å¤šï¼šEventPair, Timer å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch05-04-futex-object.html"><strong aria-hidden="true">5.4.</strong> ğŸš§ ç”¨æˆ·æ€åŒæ­¥äº’æ–¥ï¼šFutex å¯¹è±¡</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">ç®€æ˜ zCore æ•™ç¨‹</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/rcore-os/zCore-Tutorial" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="åˆè¯†å†…æ ¸å¯¹è±¡"><a class="header" href="#åˆè¯†å†…æ ¸å¯¹è±¡">åˆè¯†å†…æ ¸å¯¹è±¡</a></h1>
<h2 id="å†…æ ¸å¯¹è±¡ç®€ä»‹"><a class="header" href="#å†…æ ¸å¯¹è±¡ç®€ä»‹">å†…æ ¸å¯¹è±¡ç®€ä»‹</a></h2>
<p>åœ¨åŠ¨æ‰‹ç¼–å†™æˆ‘ä»¬çš„ä»£ç ä¹‹å‰ï¼Œéœ€è¦é¦–å…ˆè¿›è¡Œè°ƒç ”å’Œå­¦ä¹ ï¼Œå¯¹ç›®æ ‡å¯¹è±¡æœ‰ä¸€ä¸ªå…¨é¢ç³»ç»Ÿçš„äº†è§£ã€‚
è€Œäº†è§£ä¸€ä¸ªé¡¹ç›®è®¾è®¡çš„æœ€å¥½æ–¹å¼å°±æ˜¯é˜…è¯»å®˜æ–¹æä¾›çš„æ‰‹å†Œå’Œæ–‡æ¡£ã€‚</p>
<p>è®©æˆ‘ä»¬å…ˆæ¥é˜…è¯»ä¸€ä¸‹ Fuchsia å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/objects.md">å†…æ ¸å¯¹è±¡</a>ã€‚è¿™ä¸ªé“¾æ¥æ˜¯ç¤¾åŒºç¿»è¯‘çš„ä¸­æ–‡ç‰ˆï¼Œå·²ç»æœ‰äº›å¹´å¤´äº†ã€‚å¦‚æœè¯»è€…èƒ½å¤Ÿç§‘å­¦ä¸Šç½‘ï¼Œæ¨èç›´æ¥é˜…è¯»<a href="https://fuchsia.dev/fuchsia-src/reference/kernel_objects/objects">å®˜æ–¹è‹±æ–‡ç‰ˆ</a>ã€‚</p>
<p>é€šè¿‡é˜…è¯»æ–‡æ¡£ï¼Œæˆ‘ä»¬äº†è§£åˆ°ä¸å†…æ ¸å¯¹è±¡ç›¸å…³çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µï¼š<strong>å¯¹è±¡ï¼ˆObjectï¼‰ï¼Œå¥æŸ„ï¼ˆHandleï¼‰ï¼Œæƒé™ï¼ˆRightsï¼‰</strong>ã€‚å®ƒä»¬åœ¨ Zircon å†…æ ¸ä¸­çš„è§’è‰²å’Œå…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="img/ch01-01-kernel-object.png" alt="" /></p>
<p>ç®€å•æ¥è¯´ï¼š</p>
<ul>
<li>Zirconæ˜¯ä¸€ä¸ªåŸºäºå¯¹è±¡çš„å†…æ ¸ï¼Œå†…æ ¸èµ„æºè¢«æŠ½è±¡å°è£…åœ¨ä¸åŒçš„ <strong>å¯¹è±¡</strong> ä¸­ã€‚</li>
<li>ç”¨æˆ·ç¨‹åºé€šè¿‡ <strong>å¥æŸ„</strong> ä¸å†…æ ¸äº¤äº’ã€‚å¥æŸ„æ˜¯å¯¹æŸä¸€å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸”é™„åŠ äº†ç‰¹å®šçš„ <strong>æƒé™</strong>ã€‚</li>
<li>å¯¹è±¡é€šè¿‡ <strong>å¼•ç”¨è®¡æ•°</strong> ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚å¯¹äºå¤§å¤šæ•°å¯¹è±¡ï¼Œå½“æŒ‡å‘å®ƒçš„æœ€åä¸€ä¸ªå¥æŸ„å…³é—­æ—¶ï¼Œå¯¹è±¡éšä¹‹é”€æ¯ï¼Œæˆ–<a href="https://fuchsia.dev/fuchsia-src/concepts/kernel/concepts#handles_and_rights">è¿›å…¥æ— æ³•æŒ½å›çš„æœ€ç»ˆçŠ¶æ€</a>ã€‚</li>
</ul>
<p>æ­¤å¤–åœ¨å†…æ ¸å¯¹è±¡çš„æ–‡æ¡£ä¸­ï¼Œè¿˜åˆ—ä¸¾äº†ä¸€äº›<a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/objects.md#%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%8F%AF%E7%94%A8%E7%9A%84%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1">å¸¸ç”¨å¯¹è±¡</a>ã€‚ç‚¹å‡»é“¾æ¥è¿›å»å°±èƒ½æŸ¥çœ‹åˆ°è¿™ä¸ªå¯¹è±¡çš„<a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/objects/channel.md">å…·ä½“æè¿°</a>ï¼Œåœ¨é¡µé¢æœ€ä¸‹æ–¹è¿˜åˆ—ä¸¾äº†ä¸è¿™ä¸ªå¯¹è±¡ç›¸å…³çš„<a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/objects/channel.md#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">å…¨éƒ¨ç³»ç»Ÿè°ƒç”¨</a>ã€‚
è¿›ä¸€æ­¥æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨çš„ <a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/syscalls/channel_read.md#%E6%A6%82%E8%A6%81">API å®šä¹‰</a>ï¼Œä»¥åŠå®ƒçš„<a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/syscalls/channel_read.md#%E6%8F%8F%E8%BF%B0">è¡Œä¸ºæè¿°</a>ï¼Œæˆ‘ä»¬å°±èƒ½æ›´æ·±å…¥åœ°äº†è§£ç”¨æˆ·ç¨‹åºæ“ä½œå†…æ ¸å¯¹è±¡çš„ä¸€äº›ç»†èŠ‚ï¼š</p>
<ul>
<li>
<p>åˆ›å»ºï¼šæ¯ä¸€ç§å†…æ ¸å¯¹è±¡éƒ½å­˜åœ¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºå®ƒï¼Œä¾‹å¦‚ <a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/syscalls/channel_create.md"><code>zx_channel_create</code></a>ã€‚
åˆ›å»ºå¯¹è±¡æ—¶ä¸€èˆ¬éœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°é€‰é¡¹ <code>options</code>ï¼Œè‹¥åˆ›å»ºæˆåŠŸåˆ™å†…æ ¸ä¼šå°†ä¸€ä¸ªæ–°å¥æŸ„å†™å…¥ç”¨æˆ·æŒ‡å®šçš„å†…å­˜ä¸­ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ï¼šè·å¾—å¯¹è±¡å¥æŸ„åå¯ä»¥é€šè¿‡è‹¥å¹²ç³»ç»Ÿè°ƒç”¨å¯¹å®ƒè¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚ <a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/syscalls/channel_write.md"><code>zx_channel_write</code></a>ã€‚
è¿™ç±»ç³»ç»Ÿè°ƒç”¨ä¸€èˆ¬éœ€è¦ä¼ å…¥å¥æŸ„ <code>handle</code> ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå†…æ ¸é¦–å…ˆå¯¹å…¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå¥æŸ„éæ³•æˆ–è€…å¯¹è±¡ç±»å‹ä¸ç³»ç»Ÿè°ƒç”¨ä¸åŒ¹é…å°±ä¼šæŠ¥é”™ã€‚
æ¥ä¸‹æ¥å†…æ ¸ä¼šæ£€æŸ¥å¥æŸ„çš„æƒé™æ˜¯å¦æ»¡è¶³æ“ä½œçš„è¦æ±‚ï¼Œä¾‹å¦‚ <code>write</code> æ“ä½œä¸€èˆ¬è¦æ±‚å¥æŸ„å…·æœ‰ <code>WRITE</code> æƒé™ï¼Œå¦‚æœæƒé™ä¸æ»¡è¶³å°±ä¼šç»§ç»­æŠ¥é”™ã€‚</p>
</li>
<li>
<p>å…³é—­ï¼šå½“ç”¨æˆ·ç¨‹åºä¸å†ä½¿ç”¨å¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨ <a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/syscalls/handle_close.md"><code>zx_handle_close</code></a> å…³é—­å¥æŸ„ã€‚å½“ç”¨æˆ·è¿›ç¨‹é€€å‡ºæ—¶ï¼Œä»å¤„äºæ‰“å¼€çŠ¶æ€çš„å¥æŸ„ä¹Ÿéƒ½ä¼šè‡ªåŠ¨å…³é—­ã€‚</p>
</li>
</ul>
<p>æˆ‘ä»¬è¿˜å‘ç°ï¼Œæœ‰ä¸€ç±» Object ç³»ç»Ÿè°ƒç”¨æ˜¯å¯¹æ‰€æœ‰å†…æ ¸å¯¹è±¡éƒ½é€‚ç”¨çš„ã€‚
è¿™è¡¨æ˜æ‰€æœ‰å†…æ ¸å¯¹è±¡éƒ½æœ‰ä¸€äº›å…¬å…±å±æ€§ï¼Œä¾‹å¦‚ IDã€åç§°ç­‰ç­‰ã€‚æ¯ä¸€ç§å†…æ ¸å¯¹è±¡ä¹Ÿä¼šæœ‰è‡ªå·±ç‰¹æœ‰çš„å±æ€§ã€‚</p>
<p>å…¶ä¸­ä¸€äº› Object ç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·ç›¸å…³ã€‚Zircon æ¯ä¸ªå†…æ ¸å¯¹è±¡éƒ½é™„å¸¦æœ‰ 32 ä¸ª <strong><a href="https://github.com/zhangpf/fuchsia-docs-zh-CN/blob/master/zircon/docs/signals.md">ä¿¡å·ï¼ˆSignalsï¼‰</a></strong>ï¼Œå®ƒä»¬ä»£è¡¨äº†ä¸åŒç±»å‹çš„äº‹ä»¶ã€‚
ä¸ä¼ ç»Ÿ Unix ç³»ç»Ÿçš„ä¿¡å·ä¸åŒï¼Œå®ƒä¸èƒ½å¼‚æ­¥åœ°æ‰“æ–­ç”¨æˆ·ç¨‹åºè¿è¡Œï¼Œè€Œåªèƒ½ç”±ç”¨æˆ·ç¨‹åºä¸»åŠ¨åœ°é˜»å¡ç­‰å¾…åœ¨æŸä¸ªå¯¹è±¡çš„æŸäº›ä¿¡å·ä¸Šé¢ã€‚
ä¿¡å·æ˜¯ Zircon å†…æ ¸ä¸­å¾ˆé‡è¦çš„æœºåˆ¶ï¼Œä¸è¿‡è¿™éƒ¨åˆ†åœ¨å‰æœŸä¸ä¼šæ¶‰åŠï¼Œæˆ‘ä»¬ç•™åˆ°ç¬¬äº”ç« å†å…·ä½“å®ç°ã€‚</p>
<p>ä»¥ä¸Šæˆ‘ä»¬äº†è§£äº† Zircon å†…æ ¸å¯¹è±¡çš„ç›¸å…³æ¦‚å¿µå’Œä½¿ç”¨æ–¹å¼ã€‚æ¥ä¸‹æ¥åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç”¨ Rust å®ç°å†…æ ¸å¯¹è±¡çš„åŸºæœ¬æ¡†æ¶ï¼Œä»¥æ–¹ä¾¿åç»­å¿«é€Ÿå®ç°å„ç§å…·ä½“ç±»å‹çš„å†…æ ¸å¯¹è±¡ã€‚
ä»ä¼ ç»Ÿé¢å‘å¯¹è±¡è¯­è¨€çš„è§†è§’çœ‹ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨å®ç°ä¸€ä¸ªåŸºç±»ã€‚ä½†ç”±äº Rust è¯­è¨€æ¨¡å‹çš„é™åˆ¶ï¼Œè¿™ä»¶äº‹æƒ…éœ€è¦ç”¨åˆ°ä¸€äº›ç‰¹æ®Šçš„æŠ€å·§ã€‚</p>
<h2 id="å»ºç«‹é¡¹ç›®"><a class="header" href="#å»ºç«‹é¡¹ç›®">å»ºç«‹é¡¹ç›®</a></h2>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£… Rust å·¥å…·é“¾ã€‚åœ¨ Linux æˆ– macOS ç³»ç»Ÿä¸‹ï¼Œåªéœ€è¦ç”¨ä¸€ä¸ªå‘½ä»¤ä¸‹è½½å®‰è£… rustup å³å¯ï¼š</p>
<pre><code class="language-sh">$ curl https://sh.rustup.rs -sSf | sh
</code></pre>
<p>å…·ä½“å®‰è£…æ–¹æ³•å¯ä»¥å‚è€ƒ<a href="https://kaisery.github.io/trpl-zh-cn/ch01-01-installation.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ cargo åˆ›å»ºä¸€ä¸ª Rust åº“é¡¹ç›®ï¼š</p>
<pre><code class="language-sh">$ cargo new --lib zcore
$ cd zcore
</code></pre>
<p>æˆ‘ä»¬å°†åœ¨è¿™ä¸ª crate ä¸­å®ç°æ‰€æœ‰çš„å†…æ ¸å¯¹è±¡ï¼Œä»¥åº“ï¼ˆlibï¼‰è€Œä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆbinï¼‰çš„å½¢å¼ç»„ç»‡ä»£ç ï¼Œåé¢æˆ‘ä»¬ä¼šä¾èµ–å•å…ƒæµ‹è¯•ä¿è¯ä»£ç çš„æ­£ç¡®æ€§ã€‚</p>
<p>ç”±äºæˆ‘ä»¬ä¼šç”¨åˆ°ä¸€äº›ä¸ç¨³å®šï¼ˆunstableï¼‰çš„è¯­è¨€ç‰¹æ€§ï¼Œéœ€è¦ä½¿ç”¨ nightly ç‰ˆæœ¬çš„å·¥å…·é“¾ã€‚åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <code>rust-toolchain</code> æ–‡ä»¶ï¼ŒæŒ‡æ˜ä½¿ç”¨çš„å·¥å…·é“¾ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sh">{{#include ../../code/ch01-01/rust-toolchain}}
</code></pre>
<p>è¿™ä¸ªç¨‹åºåº“ç›®å‰æ˜¯åœ¨ä½ çš„ Linux æˆ– macOS ä¸Šè¿è¡Œï¼Œä½†æœ‰æœä¸€æ—¥å®ƒä¼šæˆä¸ºä¸€ä¸ªçœŸæ­£çš„ OS åœ¨è£¸æœºä¸Šè¿è¡Œã€‚
ä¸ºæ­¤æˆ‘ä»¬éœ€è¦ç§»é™¤å¯¹æ ‡å‡†åº“çš„ä¾èµ–ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªä¸ä¾èµ–å½“å‰ OS åŠŸèƒ½çš„åº“ã€‚åœ¨ <code>lib.rs</code> çš„ç¬¬ä¸€è¡Œæ·»åŠ å£°æ˜ï¼š</p>
<pre><code class="language-rust noplaypen">// src/lib.rs
#![no_std]
extern crate alloc;
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å°è¯•è¿è¡Œä¸€ä¸‹è‡ªå¸¦çš„å•å…ƒæµ‹è¯•ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…å·¥å…·é“¾ï¼š</p>
<pre><code class="language-sh">$ cargo test
    Finished test [unoptimized + debuginfo] target(s) in 0.52s
     Running target/debug/deps/zcore-dc6d43637bc5df7a

running 1 test
test tests::it_works ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre>
<h2 id="å®ç°-kernelobject-æ¥å£"><a class="header" href="#å®ç°-kernelobject-æ¥å£">å®ç° KernelObject æ¥å£</a></h2>
<p>æ‰€æœ‰çš„å†…æ ¸å¯¹è±¡æœ‰ä¸€ç³»åˆ—å…±åŒçš„å±æ€§å’Œæ–¹æ³•ï¼Œæˆ‘ä»¬ç§°è¿™äº›æ–¹æ³•ä¸ºå¯¹è±¡çš„å…¬å…±<strong>æ¥å£ï¼ˆInterfaceï¼‰</strong>ã€‚
åŒä¸€ç§æ–¹æ³•åœ¨ä¸åŒç±»å‹çš„å¯¹è±¡ä¸­å¯èƒ½ä¼šæœ‰ä¸åŒçš„è¡Œä¸ºï¼Œåœ¨é¢å‘å¯¹è±¡è¯­è¨€ä¸­æˆ‘ä»¬ç§°å…¶ä¸º<strong>å¤šæ€ï¼ˆPolymorphismï¼‰</strong>ã€‚</p>
<p>Rust æ˜¯ä¸€é—¨éƒ¨åˆ†é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨å®ƒçš„ trait å®ç°æ¥å£å’Œå¤šæ€ã€‚</p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>KernelObject</code> trait ä½œä¸ºå†…æ ¸å¯¹è±¡çš„å…¬å…±æ¥å£ï¼š</p>
<pre><code class="language-rust noplaypen">use alloc::string::String;
// src/object/mod.rs
/// å†…æ ¸å¯¹è±¡å…¬å…±æ¥å£
pub trait KernelObject: Send + Sync {
    /// è·å–å¯¹è±¡ ID
    fn id(&amp;self) -&gt; KoID;
    /// è·å–å¯¹è±¡ç±»å‹å
    fn type_name(&amp;self) -&gt; &amp;str;
    /// è·å–å¯¹è±¡åç§°
    fn name(&amp;self) -&gt; String;
    /// è®¾ç½®å¯¹è±¡åç§°
    fn set_name(&amp;self, name: &amp;str);
}

/// å¯¹è±¡ ID ç±»å‹
pub type KoID = u64;
</code></pre>
<p>è¿™é‡Œçš„ <a href="https://kaisery.github.io/trpl-zh-cn/ch16-04-extensible-concurrency-sync-and-send.html"><code>Send + Sync</code></a> æ˜¯ä¸€ä¸ªçº¦æŸæ‰€æœ‰ <code>KernelObject</code> éƒ½è¦æ»¡è¶³çš„å‰ææ¡ä»¶ï¼Œå³å®ƒå¿…é¡»æ˜¯ä¸€ä¸ª<strong>å¹¶å‘å¯¹è±¡</strong>ã€‚
æ‰€è°“å¹¶å‘å¯¹è±¡æŒ‡çš„æ˜¯<strong>å¯ä»¥å®‰å…¨åœ°è¢«å¤šçº¿ç¨‹å…±äº«è®¿é—®</strong>ã€‚äº‹å®ä¸Šæˆ‘ä»¬çš„å†…æ ¸æœ¬èº«å°±æ˜¯ä¸€ä¸ªå…±äº«åœ°å€ç©ºé—´çš„å¤šçº¿ç¨‹ç¨‹åºï¼Œåœ¨è£¸æœºä¸Šæ¯ä¸ª CPU æ ¸éƒ½å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªå¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹ã€‚
ç”±äºå†…æ ¸å¯¹è±¡å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå› æ­¤å®ƒå¿…é¡»æ˜¯å¹¶å‘å¯¹è±¡ã€‚</p>
<h2 id="å®ç°ä¸€ä¸ªç©ºå¯¹è±¡"><a class="header" href="#å®ç°ä¸€ä¸ªç©ºå¯¹è±¡">å®ç°ä¸€ä¸ªç©ºå¯¹è±¡</a></h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ä¸€ä¸ªæœ€ç®€å•çš„ç©ºå¯¹è±¡ <code>DummyObject</code>ï¼Œå¹¶ä¸ºå®ƒå®ç° <code>KernelObject</code> æ¥å£ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/object.rs
use spin::Mutex;

/// ç©ºå¯¹è±¡
#[derive(Debug)]
pub struct DummyObject {
    id: KoID,
    inner: Mutex&lt;DummyObjectInner&gt;,
}

/// `DummyObject` çš„å†…éƒ¨å¯å˜éƒ¨åˆ†
#[derive(Default, Debug)]
struct DummyObjectInner {
    name: String,
}
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç§<a href="https://kaisery.github.io/trpl-zh-cn/ch15-05-interior-mutability.html"><strong>å†…éƒ¨å¯å˜æ€§</strong></a>çš„è®¾è®¡æ¨¡å¼ï¼šå°†å¯¹è±¡çš„æ‰€æœ‰å¯å˜çš„éƒ¨åˆ†å°è£…åˆ°ä¸€ä¸ªå†…éƒ¨å¯¹è±¡ <code>DummyObjectInner</code> ä¸­ï¼Œå¹¶åœ¨åŸå¯¹è±¡ä¸­ç”¨è‡ªæ—‹é” <a href="https://docs.rs/spin/0.5.2/spin/struct.Mutex.html"><code>Mutex</code></a> æŠŠå®ƒåŒ…èµ·æ¥ï¼Œå‰©ä¸‹çš„å…¶å®ƒå­—æ®µéƒ½æ˜¯ä¸å¯å˜çš„ã€‚
<code>Mutex</code> ä¼šç”¨æœ€ç®€å•çš„æ–¹å¼å¸®æˆ‘ä»¬å¤„ç†å¥½å¹¶å‘è®¿é—®é—®é¢˜ï¼šå¦‚æœæœ‰å…¶ä»–äººæ­£åœ¨è®¿é—®ï¼Œæˆ‘å°±åœ¨è¿™é‡Œæ­»ç­‰ã€‚
æ•°æ®è¢« <code>Mutex</code> åŒ…èµ·æ¥ä¹‹åéœ€è¦é¦–å…ˆä½¿ç”¨ <a href="https://docs.rs/spin/0.5.2/spin/struct.Mutex.html#method.lock"><code>lock()</code></a> æ‹¿åˆ°é”ä¹‹åæ‰èƒ½è®¿é—®ã€‚æ­¤æ—¶å¹¶å‘è®¿é—®å·²ç»å®‰å…¨ï¼Œå› æ­¤è¢«åŒ…èµ·æ¥çš„ç»“æ„è‡ªåŠ¨å…·æœ‰äº† <code>Send + Sync</code> ç‰¹æ€§ã€‚</p>
<p>ä½¿ç”¨è‡ªæ—‹é”å¼•å…¥äº†æ–°çš„ä¾èµ–åº“ <a href="https://docs.rs/spin/0.5.2/spin/index.html"><code>spin</code></a> ï¼Œéœ€è¦åœ¨ <code>Cargo.toml</code> ä¸­åŠ å…¥ä»¥ä¸‹å£°æ˜ï¼š</p>
<pre><code class="language-toml">[dependencies]
spin = &quot;0.7&quot;
</code></pre>
<p>ç„¶åæˆ‘ä»¬ä¸ºæ–°å¯¹è±¡å®ç°æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/object.rs
use alloc::sync::Arc;
use core::sync::atomic::*;

impl DummyObject {
    /// åˆ›å»ºä¸€ä¸ªæ–° `DummyObject`
    pub fn new() -&gt; Arc&lt;Self&gt; {
        Arc::new(DummyObject {
            id: Self::new_koid(),
            inner: Default::default(),
        })
    }

    /// ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ ID
    fn new_koid() -&gt; KoID {
        static NEXT_KOID: AtomicU64 = AtomicU64::new(1024);
        NEXT_KOID.fetch_add(1, Ordering::SeqCst)
    }
}
</code></pre>
<p>æ ¹æ®æ–‡æ¡£æè¿°ï¼Œæ¯ä¸ªå†…æ ¸å¯¹è±¡éƒ½æœ‰å”¯ä¸€çš„ IDã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå…¨å±€çš„ ID åˆ†é…æ–¹æ³•ã€‚è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯ç”¨ä¸€ä¸ªé™æ€å˜é‡å­˜æ”¾ä¸‹ä¸€ä¸ªå¾…åˆ†é… ID å€¼ï¼Œæ¯æ¬¡åˆ†é…å°±åŸå­åœ° +1ã€‚
ID ç±»å‹ä½¿ç”¨ <code>u64</code>ï¼Œä¿è¯äº†æ•°å€¼ç©ºé—´è¶³å¤Ÿå¤§ï¼Œåœ¨æœ‰ç”Ÿä¹‹å¹´éƒ½ä¸ç”¨æ‹…å¿ƒæº¢å‡ºé—®é¢˜ã€‚åœ¨ Zircon ä¸­ ID ä» 1024 å¼€å§‹åˆ†é…ï¼Œ1024 ä»¥ä¸‹ä¿ç•™ä½œå†…æ ¸å†…éƒ¨ä½¿ç”¨ã€‚</p>
<p>å¦å¤–æ³¨æ„è¿™é‡Œ <code>new</code> å‡½æ•°è¿”å›ç±»å‹ä¸æ˜¯ <code>Self</code> è€Œæ˜¯ <code>Arc&lt;Self&gt;</code>ï¼Œè¿™æ˜¯ä¸ºäº†ä»¥åæ–¹ä¾¿è€Œåšçš„ç»Ÿä¸€çº¦å®šã€‚</p>
<p>æœ€åæˆ‘ä»¬ä¸ºå®ƒå®ç° <code>KernelObject</code> æ¥å£ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/object.rs
impl KernelObject for DummyObject {
    fn id(&amp;self) -&gt; KoID {
        self.id
    }
    fn type_name(&amp;self) -&gt; &amp;str {
        &quot;DummyObject&quot;
    }
    fn name(&amp;self) -&gt; String {
        self.inner.lock().name.clone()
    }
    fn set_name(&amp;self, name: &amp;str) {
        self.inner.lock().name = String::from(name);
    }
}
</code></pre>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è¿ˆå‡ºäº†ä¸‡é‡Œé•¿å¾ç¬¬ä¸€æ­¥ï¼Œå®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„åŠŸèƒ½ã€‚æœ‰å®ç°ï¼Œå°±è¦æœ‰æµ‹è¯•ï¼å³ä½¿æœ€ç®€å•çš„ä»£ç ä¹Ÿè¦ä¿è¯å®ƒçš„è¡Œä¸ºç¬¦åˆæˆ‘ä»¬é¢„æœŸã€‚
åªæœ‰å¯¹ç°æœ‰ä»£ç è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œåœ¨æœªæ¥åšæ·»åŠ å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰æœ‰ä¿¡å¿ƒä¸ä¼šæŠŠäº‹æƒ…æç ¸ã€‚ä¿—è¯è®²&quot;ä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ·&quot;ï¼ŒæŠŠåœ°åŸºæ‰“å¥½æ‰èƒ½ç›–æ‘©å¤©å¤§æ¥¼ã€‚</p>
<p>ä¸ºäº†è¯æ˜ä¸Šé¢ä»£ç çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„å•å…ƒæµ‹è¯•ï¼Œæ›¿æ¢æ‰è‡ªå¸¦çš„ <code>it_works</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/object.rs
#[cfg(test)]
mod tests {
    use super::*;
    #[test]
    fn dummy_object() {
        let o1 = DummyObject::new();
        let o2 = DummyObject::new();
        assert_ne!(o1.id(), o2.id());
        assert_eq!(o1.type_name(), &quot;DummyObject&quot;);
        assert_eq!(o1.name(), &quot;&quot;);
        o1.set_name(&quot;object1&quot;);
        assert_eq!(o1.name(), &quot;object1&quot;);
    }
}
</code></pre>
<pre><code class="language-sh">$ cargo test
    Finished test [unoptimized + debuginfo] target(s) in 0.53s
     Running target/debug/deps/zcore-ae1be84852989b13

running 1 test
test tests::dummy_object ... ok
</code></pre>
<p>å¤§åŠŸå‘Šæˆï¼è®©æˆ‘ä»¬ç”¨ <code>cargo fmt</code> å‘½ä»¤æ ¼å¼åŒ–ä¸€ä¸‹ä»£ç ï¼Œç„¶åè®°å¾— <code>git commit</code> åŠæ—¶ä¿å­˜è¿›å±•ã€‚</p>
<h2 id="å®ç°æ¥å£åˆ°å…·ä½“ç±»å‹çš„å‘ä¸‹è½¬æ¢"><a class="header" href="#å®ç°æ¥å£åˆ°å…·ä½“ç±»å‹çš„å‘ä¸‹è½¬æ¢">å®ç°æ¥å£åˆ°å…·ä½“ç±»å‹çš„å‘ä¸‹è½¬æ¢</a></h2>
<p>åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ä¼šä¼ å…¥ä¸€ä¸ªå†…æ ¸å¯¹è±¡çš„å¥æŸ„ï¼Œç„¶åå†…æ ¸ä¼šæ ¹æ®ç³»ç»Ÿè°ƒç”¨çš„ç±»å‹ï¼Œå°è¯•å°†å…¶è½¬æ¢æˆç‰¹å®šç±»å‹çš„å¯¹è±¡ã€‚
äºæ˜¯è¿™é‡Œäº§ç”Ÿäº†ä¸€ä¸ªå¾ˆé‡è¦çš„éœ€æ±‚ï¼šå°†æ¥å£ <code>Arc&lt;dyn KernelObject&gt;</code> è½¬æ¢æˆå…·ä½“ç±»å‹çš„ç»“æ„ <code>Arc&lt;T&gt; where T: KernelObject</code>ã€‚
è¿™ç§æ“ä½œåœ¨é¢å‘å¯¹è±¡è¯­è¨€ä¸­ç§°ä¸º<strong>å‘ä¸‹è½¬æ¢ï¼ˆdowncastï¼‰</strong>ã€‚</p>
<p>åœ¨å¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå‘ä¸‹è½¬æ¢éƒ½æ˜¯ä¸€ä»¶éå¸¸è½»æ¾çš„äº‹æƒ…ã€‚ä¾‹å¦‚åœ¨ C/C++ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>
<pre><code class="language-c++">struct KernelObject {...};
struct DummyObject: KernelObject {...};

KernelObject *base = ...;
// C é£æ ¼ï¼šå¼ºåˆ¶ç±»å‹è½¬æ¢
DummyObject *dummy = (DummyObject*)(base);
// C++ é£æ ¼ï¼šåŠ¨æ€ç±»å‹è½¬æ¢
DummyObject *dummy = dynamic_cast&lt;DummyObject*&gt;(base);
</code></pre>
<p>ä½†åœ¨ Rust ä¸­ï¼Œç”±äºå…¶ trait æ¨¡å‹çš„é™åˆ¶ï¼Œå‘ä¸‹è½¬æ¢å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚
è™½ç„¶æ ‡å‡†åº“ä¸­æä¾›äº† <a href="https://doc.rust-lang.org/std/any/"><code>Any</code></a> traitï¼Œéƒ¨åˆ†å®ç°äº†åŠ¨æ€ç±»å‹çš„åŠŸèƒ½ï¼Œä½†å®é™…æ“ä½œèµ·æ¥å´å›°éš¾é‡é‡ã€‚
ä¸ä¿¡é‚ªçš„åŒå­¦å¯ä»¥è‡ªå·±æŠ˜è…¾ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust editable edition2018"><span class="boring">use std::any::Any;
</span><span class="boring">use std::sync::Arc;
</span><span class="boring">fn main() {}
</span>
trait KernelObject: Any + Send + Sync {}
fn downcast_v1&lt;T: KernelObject&gt;(object: Arc&lt;dyn KernelObject&gt;) -&gt; Arc&lt;T&gt; {
    object.downcast::&lt;T&gt;().unwrap()
}
fn downcast_v2&lt;T: KernelObject&gt;(object: Arc&lt;dyn KernelObject&gt;) -&gt; Arc&lt;T&gt; {
    let object: Arc&lt;dyn Any + Send + Sync + 'static&gt; = object;
    object.downcast::&lt;T&gt;().unwrap()
}
</code></pre></pre>
<p>å½“ç„¶è¿™ä¸ªé—®é¢˜ä¹Ÿå›°æ‰°äº† Rust ç¤¾åŒºä¸­çš„å¾ˆå¤šäººã€‚ç›®å‰å·²ç»æœ‰äººæå‡ºäº†ä¸€å¥—ä¸é”™çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å¼•å…¥çš„ <a href="https://docs.rs/downcast-rs/1.2.0/downcast_rs/index.html"><code>downcast-rs</code></a> åº“ï¼š</p>
<pre><code class="language-toml">[dependencies]
downcast-rs = { version = &quot;1.2.0&quot;, default-features = false }
</code></pre>
<p>ï¼ˆé¢˜å¤–è¯ï¼šè¿™ä¸ªåº“åŸæ¥æ˜¯ä¸æ”¯æŒ <code>no_std</code> çš„ï¼ŒzCore æœ‰è¿™ä¸ªéœ€æ±‚ï¼Œäºæ˜¯å°±é¡ºä¾¿å¸®ä»–å®ç°äº†ä¸€æŠŠï¼‰</p>
<p>æŒ‰ç…§å®ƒæ–‡æ¡£çš„æè¿°ï¼Œæˆ‘ä»¬è¦ä¸ºè‡ªå·±çš„æ¥å£å®ç°å‘ä¸‹è½¬æ¢ï¼Œåªéœ€ä»¥ä¸‹ä¿®æ”¹ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/mod.rs
use core::fmt::Debug;
use downcast_rs::{impl_downcast, DowncastSync};

pub trait KernelObject: DowncastSync + Debug {...}
impl_downcast!(sync KernelObject);
</code></pre>
<p>å…¶ä¸­ <code>DowncastSync</code> ä»£æ›¿äº†åŸæ¥çš„ <code>Send + Sync</code>ï¼Œ<code>Debug</code> ç”¨äºå‡ºé”™æ—¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯ã€‚
<code>impl_downcast!</code> å®ç”¨æ¥å¸®æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆè½¬æ¢å‡½æ•°ï¼Œç„¶åå°±å¯ä»¥ç”¨ <code>downcast_arc</code> æ¥å¯¹ <code>Arc</code> åšå‘ä¸‹è½¬æ¢äº†ã€‚æˆ‘ä»¬ç›´æ¥æ¥æµ‹è¯•ä¸€æŠŠï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/object.rs
#[test]
fn downcast() {
    let dummy = DummyObject::new();
    let object: Arc&lt;dyn KernelObject&gt; = dummy;
    let _result: Arc&lt;DummyObject&gt; = object.downcast_arc::&lt;DummyObject&gt;().unwrap();
}
</code></pre>
<pre><code class="language-sh">$ cargo test
    Finished test [unoptimized + debuginfo] target(s) in 0.47s
     Running target/debug/deps/zcore-ae1be84852989b13

running 2 tests
test object::downcast ... ok
test object::tests::dummy_object ... ok
</code></pre>
<h2 id="æ¨¡æ‹Ÿç»§æ‰¿ç”¨å®è‡ªåŠ¨ç”Ÿæˆæ¥å£å®ç°ä»£ç "><a class="header" href="#æ¨¡æ‹Ÿç»§æ‰¿ç”¨å®è‡ªåŠ¨ç”Ÿæˆæ¥å£å®ç°ä»£ç ">æ¨¡æ‹Ÿç»§æ‰¿ï¼šç”¨å®è‡ªåŠ¨ç”Ÿæˆæ¥å£å®ç°ä»£ç </a></h2>
<p>ä¸Šé¢æˆ‘ä»¬å·²ç»å®Œæ•´å®ç°äº†ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œä»£ç çœ‹èµ·æ¥å¾ˆç®€æ´ã€‚ä½†å½“æˆ‘ä»¬è¦å®ç°æ›´å¤šå¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼š
è¿™äº›å¯¹è±¡æ‹¥æœ‰ä¸€äº›å…¬å…±å±æ€§ï¼Œæ¥å£æ–¹æ³•ä¹Ÿæœ‰å…±åŒçš„å®ç°ã€‚
åœ¨ä¼ ç»Ÿ OOP è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <strong>ç»§æ‰¿ï¼ˆinheritanceï¼‰</strong> æ¥å¤ç”¨è¿™äº›å…¬å…±ä»£ç ï¼šå­ç±» B å¯ä»¥ç»§æ‰¿çˆ¶ç±» Aï¼Œç„¶åè‡ªåŠ¨æ‹¥æœ‰çˆ¶ç±»çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•ã€‚</p>
<p>ç»§æ‰¿æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†åœ¨é•¿æœŸå®è·µä¸­äººä»¬ä¹Ÿé€æ¸å‘ç°äº†å®ƒçš„å¼Šç«¯ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥çœ‹ä¸€çœ‹çŸ¥ä¹ä¸Šçš„æ¢è®¨ï¼š<a href="https://www.zhihu.com/question/20275578/answer/26577791"><em>é¢å‘å¯¹è±¡ç¼–ç¨‹çš„å¼Šç«¯æ˜¯ä»€ä¹ˆï¼Ÿ</em></a>ã€‚
ç»å…¸è‘—ä½œã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸­å°±é¼“åŠ±å¤§å®¶<strong>ä½¿ç”¨ç»„åˆä»£æ›¿ç»§æ‰¿</strong>ã€‚è€Œä¸€äº›ç°ä»£çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ Go å’Œ Rustï¼Œç”šè‡³ç›´æ¥æŠ›å¼ƒäº†ç»§æ‰¿ã€‚åœ¨ Rust ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ç»„åˆç»“æ„å’Œ <a href="https://kaisery.github.io/trpl-zh-cn/ch15-02-deref.html"><code>Deref</code></a> trait æ¥éƒ¨åˆ†æ¨¡æ‹Ÿç»§æ‰¿ã€‚</p>
<blockquote>
<p>ç»§æ‰¿é‡è›®ï¼Œtrait æ–‡æ˜ã€‚ â€”â€” æŸ Rust çˆ±å¥½è€…</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¨¡ä»¿ <code>downcast-rs</code> åº“çš„åšæ³•ï¼Œä½¿ç”¨ä¸€ç§åŸºäºå®çš„ä»£ç ç”Ÿæˆæ–¹æ¡ˆï¼Œæ¥å®ç° <code>KernelObject</code> çš„ç»§æ‰¿ã€‚
å½“ç„¶è¿™åªæ˜¯æŠ›ç –å¼•ç‰ï¼Œå¦‚æœè¯»è€…è‡ªå·±å®ç°äº†ï¼Œæˆ–è€…äº†è§£åˆ°ç¤¾åŒºä¸­æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ¬¢è¿æŒ‡å‡ºã€‚</p>
<p>å…·ä½“åšæ³•æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>ä½¿ç”¨ä¸€ä¸ª struct æ¥æä¾›æ‰€æœ‰çš„å…¬å…±å±æ€§å’Œæ–¹æ³•ï¼Œä½œä¸ºæ‰€æœ‰å­ç±»çš„ç¬¬ä¸€ä¸ªæˆå‘˜ã€‚</li>
<li>ä¸ºå­ç±»å®ç° trait æ¥å£ï¼Œæ‰€æœ‰æ–¹æ³•ç›´æ¥å§”æ‰˜ç»™å†…éƒ¨ struct å®Œæˆã€‚è¿™éƒ¨åˆ†ä½¿ç”¨å®æ¥è‡ªåŠ¨ç”Ÿæˆæ¨¡æ¿ä»£ç ã€‚</li>
</ul>
<p>è€Œæ‰€è°“çš„å†…éƒ¨ structï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬ä¸Šé¢å®ç°çš„ <code>DummyObject</code>ã€‚ä¸ºäº†æ›´å¥½åœ°ä½“ç°å®ƒçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç»™ä»–æ”¹ä¸ªåå« <code>KObjectBase</code>ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/mod.rs
/// å†…æ ¸å¯¹è±¡æ ¸å¿ƒç»“æ„
pub struct KObjectBase {
    /// å¯¹è±¡ ID
    pub id: KoID,
    inner: Mutex&lt;KObjectBaseInner&gt;,
}

/// `KObjectBase` çš„å†…éƒ¨å¯å˜éƒ¨åˆ†
#[derive(Default)]
struct KObjectBaseInner {
    name: String,
}
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠå®ƒçš„æ„é€ å‡½æ•°æ”¹ä¸ºå®ç° <code>Default</code> traitï¼Œå¹¶ä¸”å…¬å…±å±æ€§å’Œæ–¹æ³•éƒ½æŒ‡å®šä¸º <code>pub</code>ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/mod.rs
impl Default for KObjectBase {
    /// åˆ›å»ºä¸€ä¸ªæ–° `KObjectBase`
    fn default() -&gt; Self {
        KObjectBase {
            id: Self::new_koid(),
            inner: Default::default(),
        }
    }
}
impl KObjectBase {
    /// ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ ID
    fn new_koid() -&gt; KoID {...}
    /// è·å–å¯¹è±¡åç§°
    pub fn name(&amp;self) -&gt; String {...}
    /// è®¾ç½®å¯¹è±¡åç§°
    pub fn set_name(&amp;self, name: &amp;str) {...}
}
</code></pre>
<p>æœ€åæ¥å†™ä¸€ä¸ªé­”æ³•çš„å®ï¼</p>
<pre><code class="language-rust noplaypen">// src/object/mod.rs
/// ä¸ºå†…æ ¸å¯¹è±¡ struct è‡ªåŠ¨å®ç° `KernelObject` trait çš„å®ã€‚
#[macro_export] // å¯¼å‡ºå®ï¼Œå¯åœ¨ crate å¤–éƒ¨ä½¿ç”¨
macro_rules! impl_kobject {
    // åŒ¹é…ç±»å‹åï¼Œå¹¶å¯ä»¥æä¾›å‡½æ•°è¦†ç›–é»˜è®¤å®ç°
    ($class:ident $( $fn:tt )*) =&gt; {
        // ä¸ºå¯¹è±¡å®ç° KernelObject traitï¼Œæ–¹æ³•ç›´æ¥è½¬å‘åˆ°å†…éƒ¨ struct
        impl KernelObject for $class {
            fn id(&amp;self) -&gt; KoID {
                // ç›´æ¥è®¿é—®å†…éƒ¨çš„ pub å±æ€§
                self.base.id
            }
            fn type_name(&amp;self) -&gt; &amp;str {
                // ç”¨ stringify! å®å°†è¾“å…¥è½¬æˆå­—ç¬¦ä¸²
                stringify!($class)
            }
            // æ³¨æ„å®é‡Œé¢çš„ç±»å‹è¦å†™å®Œæ•´è·¯å¾„ï¼Œä¾‹å¦‚ï¼šalloc::string::String
            fn name(&amp;self) -&gt; alloc::string::String {
                self.base.name()
            }
            fn set_name(&amp;self, name: &amp;str){
                // ç›´æ¥è®¿é—®å†…éƒ¨çš„ pub æ–¹æ³•
                self.base.set_name(name)
            }
            // å¯ä»¥ä¼ å…¥ä»»æ„æ•°é‡çš„å‡½æ•°ï¼Œè¦†ç›– trait çš„é»˜è®¤å®ç°
            $( $fn )*
        }
        // ä¸ºå¯¹è±¡å®ç° Debug trait
        impl core::fmt::Debug for $class {
            fn fmt(
                &amp;self,
                f: &amp;mut core::fmt::Formatter&lt;'_&gt;,
            ) -&gt; core::result::Result&lt;(), core::fmt::Error&gt; {
                // è¾“å‡ºå¯¹è±¡ç±»å‹ã€ID å’Œåç§°
                f.debug_tuple(&amp;stringify!($class))
                    .field(&amp;self.id())
                    .field(&amp;self.name())
                    .finish()
            }
        }
    };
}
</code></pre>
<p>è½®å­å·²ç»é€ å¥½äº†ï¼è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç”¨å®ƒæ–¹ä¾¿åœ°å®ç°ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œä»ä»¥ <code>DummyObject</code> ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/mod.rs
/// ç©ºå¯¹è±¡
pub struct DummyObject {
    // å…¶ä¸­å¿…é¡»åŒ…å«ä¸€ä¸ªåä¸º `base` çš„ `KObjectBase`
    base: KObjectBase,
}

// ä½¿ç”¨åˆšæ‰çš„å®ï¼Œå£°æ˜å…¶ä¸ºå†…æ ¸å¯¹è±¡ï¼Œè‡ªåŠ¨ç”Ÿæˆå¿…è¦çš„ä»£ç 
impl_kobject!(DummyObject);

impl DummyObject {
    /// åˆ›å»ºä¸€ä¸ªæ–° `DummyObject`
    pub fn new() -&gt; Arc&lt;Self&gt; {
        Arc::new(DummyObject {
            base: KObjectBase::default(),
        })
    }
}
</code></pre>
<p>æ˜¯ä¸æ˜¯æ–¹ä¾¿äº†å¾ˆå¤šï¼Ÿæœ€åæŒ‰ç…§æƒ¯ä¾‹ï¼Œç”¨å•å…ƒæµ‹è¯•æ£€éªŒå®ç°çš„æ­£ç¡®æ€§ï¼š</p>
<pre><code class="language-rust noplaypen">// src/object/mod.rs
#[test]
fn impl_kobject() {
    use alloc::format;
    let dummy = DummyObject::new();
    let object: Arc&lt;dyn KernelObject&gt; = dummy;
    assert_eq!(object.type_name(), &quot;DummyObject&quot;);
    assert_eq!(object.name(), &quot;&quot;);
    object.set_name(&quot;dummy&quot;);
    assert_eq!(object.name(), &quot;dummy&quot;);
    assert_eq!(
        format!(&quot;{:?}&quot;, object),
        format!(&quot;DummyObject({}, \&quot;dummy\&quot;)&quot;, object.id())
    );
    let _result: Arc&lt;DummyObject&gt; = object.downcast_arc::&lt;DummyObject&gt;().unwrap();
}
</code></pre>
<p>æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ç»§ç»­æ¢ç´¢ä½¿ç”¨åŠŸèƒ½æ›´å¼ºå¤§çš„ <a href="https://doc.rust-lang.org/proc_macro/index.html"><strong>è¿‡ç¨‹å®ï¼ˆproc_macroï¼‰</strong></a>ï¼Œè¿›ä¸€æ­¥ç®€åŒ–å®ç°æ–°å†…æ ¸å¯¹è±¡æ‰€éœ€çš„æ¨¡æ¿ä»£ç ã€‚
å¦‚æœèƒ½æŠŠä¸Šé¢çš„ä»£ç å—ç¼©å°æˆä¸‹é¢è¿™ä¸¤è¡Œï¼Œå°±æ›´åŠ å®Œç¾äº†ï¼š</p>
<pre><code class="language-rust noplaypen">#[KernelObject]
pub struct DummyObject;
</code></pre>
<h2 id="æ€»ç»“"><a class="header" href="#æ€»ç»“">æ€»ç»“</a></h2>
<p>åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬ç”¨ Rust è¯­è¨€å®ç°äº† Zircon æœ€æ ¸å¿ƒçš„<strong>å†…æ ¸å¯¹è±¡</strong>æ¦‚å¿µã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­æ¶‰åŠåˆ° Rust çš„ä¸€ç³»åˆ—è¯­è¨€ç‰¹æ€§å’Œè®¾è®¡æ¨¡å¼ï¼š</p>
<ul>
<li>ä½¿ç”¨ <strong>trait</strong> å®ç°æ¥å£</li>
<li>ä½¿ç”¨ <strong>å†…éƒ¨å¯å˜æ€§</strong> æ¨¡å¼å®ç°å¹¶å‘å¯¹è±¡</li>
<li>åŸºäºç¤¾åŒºè§£å†³æ–¹æ¡ˆå®ç° trait åˆ° struct çš„ <strong>å‘ä¸‹è½¬æ¢</strong></li>
<li>ä½¿ç”¨ç»„åˆæ¨¡æ‹Ÿç»§æ‰¿ï¼Œå¹¶ä½¿ç”¨ <strong>å®</strong> å®ç°æ¨¡æ¿ä»£ç çš„è‡ªåŠ¨ç”Ÿæˆ</li>
</ul>
<p>ç”±äº Rust ç‹¬ç‰¹çš„<a href="https://kaisery.github.io/trpl-zh-cn/ch17-00-oop.html">é¢å‘å¯¹è±¡ç¼–ç¨‹ç‰¹æ€§</a>ï¼Œæˆ‘ä»¬åœ¨å®ç°å†…æ ¸å¯¹è±¡çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€å®šçš„æŒ‘æˆ˜ã€‚
ä¸è¿‡ä¸‡äº‹å¼€å¤´éš¾ï¼Œè§£å†³è¿™äº›é—®é¢˜ä¸ºæ•´ä¸ªé¡¹ç›®æ‰“ä¸‹äº†åšå®åŸºç¡€ï¼Œåé¢å®ç°æ–°çš„å†…æ ¸å¯¹è±¡å°±ä¼šå˜å¾—ç®€å•å¾ˆå¤šã€‚</p>
<p>åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å†…æ ¸å¯¹è±¡ç›¸å…³çš„å¦å¤–ä¸¤ä¸ªæ¦‚å¿µï¼šå¥æŸ„å’Œæƒé™ï¼Œå¹¶å®ç°å†…æ ¸å¯¹è±¡çš„å­˜å‚¨å’Œè®¿é—®ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="ch01-00-object.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="ch01-02-process-object.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="ch01-00-object.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="ch01-02-process-object.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
                <script src="ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
