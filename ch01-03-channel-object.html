<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ğŸš§ å¯¹è±¡ä¼ é€å™¨ï¼šChannel å¯¹è±¡ - ç®€æ˜ zCore æ•™ç¨‹</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">ç®€æ˜ zCore æ•™ç¨‹</a></li><li class="chapter-item expanded affix "><a href="zcore-intro.html">ğŸš§ zCore æ•´ä½“ç»“æ„å’Œè®¾è®¡æ¨¡å¼</a></li><li class="chapter-item expanded affix "><a href="fuchsia.html">ğŸš§ Fuchsia OS å’Œ Zircon å¾®å†…æ ¸</a></li><li class="chapter-item expanded "><a href="ch01-00-object.html"><strong aria-hidden="true">1.</strong> å†…æ ¸å¯¹è±¡</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch01-01-kernel-object.html"><strong aria-hidden="true">1.1.</strong> âœ… åˆè¯†å†…æ ¸å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch01-02-process-object.html"><strong aria-hidden="true">1.2.</strong> ğŸš§ å¯¹è±¡ç®¡ç†å™¨ï¼šProcess å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch01-03-channel-object.html" class="active"><strong aria-hidden="true">1.3.</strong> ğŸš§ å¯¹è±¡ä¼ é€å™¨ï¼šChannel å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch02-00-task.html"><strong aria-hidden="true">2.</strong> ä»»åŠ¡ç®¡ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch02-01-zircon-task.html"><strong aria-hidden="true">2.1.</strong> ğŸš§ Zircon ä»»åŠ¡ç®¡ç†ä½“ç³»</a></li><li class="chapter-item expanded "><a href="ch02-02-process-job-object.html"><strong aria-hidden="true">2.2.</strong> ğŸš§ è¿›ç¨‹ç®¡ç†ï¼šProcess ä¸ Job å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch02-03-thread-object.html"><strong aria-hidden="true">2.3.</strong> ğŸš§ çº¿ç¨‹ç®¡ç†ï¼šThread å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch03-00-memory.html"><strong aria-hidden="true">3.</strong> å†…å­˜ç®¡ç†</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-01-zircon-memory.html"><strong aria-hidden="true">3.1.</strong> ğŸš§ Zircon å†…å­˜ç®¡ç†æ¨¡å‹</a></li><li class="chapter-item expanded "><a href="ch03-02-vmo.html"><strong aria-hidden="true">3.2.</strong> ğŸš§ ç‰©ç†å†…å­˜ï¼šVMO å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch03-03-vmo-paged.html"><strong aria-hidden="true">3.3.</strong> ğŸš§ ç‰©ç†å†…å­˜ï¼šæŒ‰é¡µåˆ†é…çš„ VMO</a></li><li class="chapter-item expanded "><a href="ch03-04-vmar.html"><strong aria-hidden="true">3.4.</strong> ğŸš§ è™šæ‹Ÿå†…å­˜ï¼šVMAR å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch04-00-userspace.html"><strong aria-hidden="true">4.</strong> ç”¨æˆ·ç¨‹åº</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch04-01-user-program.html"><strong aria-hidden="true">4.1.</strong> ğŸš§ Zircon ç”¨æˆ·ç¨‹åº</a></li><li class="chapter-item expanded "><a href="ch04-02-context-switch.html"><strong aria-hidden="true">4.2.</strong> ğŸš§ ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li><li class="chapter-item expanded "><a href="ch04-03-syscall.html"><strong aria-hidden="true">4.3.</strong> ğŸš§ ç³»ç»Ÿè°ƒç”¨</a></li></ol></li><li class="chapter-item expanded "><a href="ch05-00-signal-and-waiting.html"><strong aria-hidden="true">5.</strong> ä¿¡å·å’Œç­‰å¾…</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch05-01-wait-signal.html"><strong aria-hidden="true">5.1.</strong> ğŸš§ ç­‰å¾…å†…æ ¸å¯¹è±¡çš„ä¿¡å·</a></li><li class="chapter-item expanded "><a href="ch05-02-port-object.html"><strong aria-hidden="true">5.2.</strong> ğŸš§ åŒæ—¶ç­‰å¾…å¤šä¸ªä¿¡å·ï¼šPort å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch05-03-more-signal-objects.html"><strong aria-hidden="true">5.3.</strong> ğŸš§ å®ç°æ›´å¤šï¼šEventPair, Timer å¯¹è±¡</a></li><li class="chapter-item expanded "><a href="ch05-04-futex-object.html"><strong aria-hidden="true">5.4.</strong> ğŸš§ ç”¨æˆ·æ€åŒæ­¥äº’æ–¥ï¼šFutex å¯¹è±¡</a></li></ol></li><li class="chapter-item expanded "><a href="ch06-00-hal.html"><strong aria-hidden="true">6.</strong> ç¡¬ä»¶æŠ½è±¡å±‚</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch06-01-zcore-hal-unix.html"><strong aria-hidden="true">6.1.</strong> âœ… UNIXç¡¬ä»¶æŠ½è±¡å±‚</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">ç®€æ˜ zCore æ•™ç¨‹</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/rcore-os/zCore-Tutorial" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="å¯¹è±¡ä¼ é€å™¨channel-å¯¹è±¡"><a class="header" href="#å¯¹è±¡ä¼ é€å™¨channel-å¯¹è±¡">å¯¹è±¡ä¼ é€å™¨ï¼šChannel å¯¹è±¡</a></h1>
<h2 id="æ¦‚è¦"><a class="header" href="#æ¦‚è¦">æ¦‚è¦</a></h2>
<p>é€šé“ï¼ˆChannelï¼‰æ˜¯ç”±ä¸€å®šæ•°é‡çš„å­—èŠ‚æ•°æ®å’Œä¸€å®šæ•°é‡çš„å¥æŸ„ç»„æˆçš„åŒå‘æ¶ˆæ¯ä¼ è¾“ã€‚</p>
<h2 id="ç”¨äºipcçš„å†…æ ¸å¯¹è±¡"><a class="header" href="#ç”¨äºipcçš„å†…æ ¸å¯¹è±¡">ç”¨äºIPCçš„å†…æ ¸å¯¹è±¡</a></h2>
<p>Zirconä¸­ç”¨äºIPCçš„å†…æ ¸å¯¹è±¡ä¸»è¦æœ‰Channelã€Socketå’ŒFIFOã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦ä»‹ç»ä¸€ä¸‹å‰ä¸¤ä¸ªã€‚</p>
<blockquote>
<p><strong>è¿›ç¨‹é—´é€šä¿¡</strong>ï¼ˆ<strong>IPC</strong>ï¼Œ<em>Inter-Process Communication</em>ï¼‰ï¼ŒæŒ‡è‡³å°‘ä¸¤ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹é—´ä¼ é€æ•°æ®æˆ–ä¿¡å·çš„ä¸€äº›æŠ€æœ¯æˆ–æ–¹æ³•ã€‚è¿›ç¨‹æ˜¯è®¡ç®—æœºç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€å°å•ä½(è¿›ç¨‹æ˜¯åˆ†é…èµ„æºæœ€å°çš„å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯è°ƒåº¦çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹å…±ç”¨è¿›ç¨‹èµ„æº)ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€éƒ¨åˆ†ç‹¬ç«‹çš„ç³»ç»Ÿèµ„æºï¼Œå½¼æ­¤æ˜¯éš”ç¦»çš„ã€‚ä¸ºäº†èƒ½ä½¿ä¸åŒçš„è¿›ç¨‹äº’ç›¸è®¿é—®èµ„æºå¹¶è¿›è¡Œåè°ƒå·¥ä½œï¼Œæ‰æœ‰äº†è¿›ç¨‹é—´é€šä¿¡ã€‚ä¸¾ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡çš„ä¸¤ä¸ªåº”ç”¨å¯ä»¥è¢«åˆ†ç±»ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡ç«¯å›å¤å®¢æˆ·ç«¯çš„æ•°æ®è¯·æ±‚ã€‚æœ‰ä¸€äº›åº”ç”¨æœ¬èº«æ—¢æ˜¯æœåŠ¡å™¨åˆæ˜¯å®¢æˆ·ç«¯ï¼Œè¿™åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼Œæ—¶å¸¸å¯ä»¥è§åˆ°ã€‚è¿™äº›è¿›ç¨‹å¯ä»¥è¿è¡Œåœ¨åŒä¸€è®¡ç®—æœºä¸Šæˆ–ç½‘ç»œè¿æ¥çš„ä¸åŒè®¡ç®—æœºä¸Šã€‚</p>
</blockquote>
<p><code>Socket</code>å’Œ<code>Channel</code>éƒ½æ˜¯åŒå‘å’ŒåŒç«¯çš„IPCç›¸å…³çš„<code>Object</code>ã€‚åˆ›å»º<code>Socket</code>æˆ–<code>Channel</code>å°†è¿”å›ä¸¤ä¸ªä¸åŒçš„<code>Handle</code>ï¼Œåˆ†åˆ«æŒ‡å‘<code>Socket</code>æˆ–<code>Channel</code>çš„ä¸¤ç«¯ã€‚ä¸channelçš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œsocketä»…èƒ½ä¼ è¾“æ•°æ®ï¼ˆè€Œä¸ç§»åŠ¨å¥æŸ„ï¼‰ï¼Œè€Œchannelå¯ä»¥ä¼ é€’å¥æŸ„ã€‚</p>
<ul>
<li><code>Socket</code>æ˜¯é¢å‘æµçš„å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡å®ƒè¯»å–æˆ–å†™å…¥ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚ä¸ºå•ä½çš„æ•°æ®ã€‚</li>
<li><code>Channel</code>æ˜¯é¢å‘æ•°æ®åŒ…çš„å¯¹è±¡ï¼Œå¹¶é™åˆ¶æ¶ˆæ¯çš„å¤§å°æœ€å¤šä¸º64Kï¼ˆå¦‚æœæœ‰æ”¹å˜ï¼Œå¯èƒ½ä¼šæ›´å°ï¼‰ï¼Œä»¥åŠæœ€å¤š1024ä¸ª<code>Handle</code>æŒ‚è½½åˆ°åŒä¸€æ¶ˆæ¯ä¸Šï¼ˆå¦‚æœæœ‰æ”¹å˜ï¼ŒåŒæ ·å¯èƒ½ä¼šæ›´å°ï¼‰ã€‚</li>
</ul>
<p>å½“<code>Handle</code>è¢«å†™å…¥åˆ°<code>Channel</code>ä¸­æ—¶ï¼Œåœ¨å‘é€ç«¯<code>Process</code>ä¸­å°†ä¼šç§»é™¤è¿™äº›<code>Handle</code>ã€‚åŒæ—¶æºå¸¦<code>Handle</code>çš„æ¶ˆæ¯ä»<code>Channel</code>ä¸­è¢«è¯»å–æ—¶ï¼Œè¯¥<code>Handle</code>ä¹Ÿå°†è¢«åŠ å…¥åˆ°æ¥æ”¶ç«¯<code>Process</code>ä¸­ã€‚åœ¨è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´æ—¶ï¼Œ<code>Handle</code>å°†åŒæ—¶å­˜åœ¨äºä¸¤ç«¯ï¼ˆä»¥ä¿è¯å®ƒä»¬æŒ‡å‘çš„<code>Object</code>ç»§ç»­å­˜åœ¨è€Œä¸è¢«é”€æ¯ï¼‰ï¼Œé™¤é<code>Channel</code>å†™å…¥æ–¹å‘ä¸€ç«¯è¢«å…³é—­ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒæŒ‡å‘è¯¥ç«¯ç‚¹çš„æ­£åœ¨å‘é€çš„æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒï¼Œå¹¶ä¸”å®ƒä»¬åŒ…å«çš„ä»»ä½•å¥æŸ„éƒ½å°†è¢«å…³é—­ã€‚</p>
<h2 id="channel"><a class="header" href="#channel">Channel</a></h2>
<p>Channelæ˜¯å”¯ä¸€ä¸€ä¸ªèƒ½ä¼ é€’handleçš„IPCï¼Œå…¶ä»–åªèƒ½ä¼ é€’æ¶ˆæ¯ã€‚é€šé“æœ‰ä¸¤ä¸ªç«¯ç‚¹<code>endpoints</code>ï¼Œå¯¹äºä»£ç å®ç°æ¥è¯´ï¼Œ<strong>é€šé“æ˜¯è™šæ‹Ÿçš„ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯ç”¨é€šé“çš„ä¸¤ä¸ªç«¯ç‚¹æ¥æè¿°ä¸€ä¸ªé€šé“</strong>ã€‚ä¸¤ä¸ªç«¯ç‚¹å„è‡ªè¦ç»´æŠ¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨ä¸€ä¸ªç«¯ç‚¹å†™æ¶ˆæ¯ï¼Œå®é™…ä¸Šæ˜¯æŠŠæ¶ˆæ¯å†™å…¥<strong>å¦ä¸€ä¸ªç«¯ç‚¹</strong>çš„æ¶ˆæ¯é˜Ÿåˆ—é˜Ÿå°¾ï¼›åœ¨ä¸€ä¸ªç«¯ç‚¹è¯»æ¶ˆæ¯ï¼Œå®é™…ä¸Šæ˜¯ä»<strong>å½“å‰ç«¯ç‚¹</strong>çš„æ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿå¤´è¯»å‡ºä¸€ä¸ªæ¶ˆæ¯ã€‚</p>
<p>æ¶ˆæ¯é€šå¸¸å«æœ‰<code>data</code>å’Œ<code>handles</code>ä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¿™é‡Œå°†æ¶ˆæ¯å°è£…ä¸º<code>MessagePacket</code>ç»“æ„ä½“ï¼Œç»“æ„ä½“ä¸­å«æœ‰ä¸Šè¿°ä¸¤ä¸ªå­—æ®µï¼š</p>
<pre><code class="language-rust noplaypen">#[derive(Default)]
pub struct MessagePacket {
    /// message packetæºå¸¦çš„æ•°æ®data
    pub data: Vec&lt;u8&gt;,
    /// message packetæºå¸¦çš„å¥æŸ„Handle
    pub handles: Vec&lt;Handle&gt;,
}
</code></pre>
<h3 id="å®ç°ç©ºçš„channelå¯¹è±¡"><a class="header" href="#å®ç°ç©ºçš„channelå¯¹è±¡">å®ç°ç©ºçš„Channelå¯¹è±¡</a></h3>
<p>åœ¨<code>src</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>ipc</code>ç›®å½•ï¼Œåœ¨<code>ipc</code>æ¨¡å—ä¸‹å®šä¹‰ä¸€ä¸ªå­æ¨¡å—<code>channel</code>ï¼š</p>
<pre><code class="language-rust noplaypen">// src/ipc/mod.rs
use super::*;

mod channel;
pub use self::channel::*;
</code></pre>
<p>åœ¨<code>ipc.rs</code>ä¸­å¼•å…¥<code>crate</code>ï¼š</p>
<pre><code class="language-rust noplaypen">// src/ipc/channel.rs

use {
    super::*,
    crate::error::*,
    crate::object::*,
    alloc::collections::VecDeque,
    alloc::sync::{Arc, Weak},
    spin::Mutex,
};
</code></pre>
<p>æŠŠåœ¨ä¸Šé¢æåˆ°çš„<code>MessagePacket</code>ç»“æ„ä½“æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ·»åŠ Channelç»“æ„ä½“ï¼š</p>
<pre><code class="language-rust noplaypen">// src/ipc/channel.rs
pub struct Channel {
    base: KObjectBase,
    peer: Weak&lt;Channel&gt;,
    recv_queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
}

type T = MessagePacket;
</code></pre>
<p><code>peer</code>ä»£è¡¨å½“å‰ç«¯ç‚¹æ‰€åœ¨ç®¡é“çš„å¦ä¸€ä¸ªç«¯ç‚¹ï¼Œä¸¤ç«¯çš„ç»“æ„ä½“åˆ†åˆ«æŒæœ‰å¯¹æ–¹çš„<code>Weak</code>å¼•ç”¨ï¼Œå¹¶ä¸”ä¸¤ç«¯çš„ç»“æ„ä½“å°†åˆ†åˆ«é€šè¿‡<code>Arc</code>å¼•ç”¨ï¼Œä½œä¸ºå†…æ ¸å¯¹è±¡è€Œè¢«å†…æ ¸ä¸­çš„å…¶ä»–æ•°æ®ç»“æ„å¼•ç”¨ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†åœ¨åˆ›å»ºChannelå®ä¾‹æ—¶æåˆ°ã€‚</p>
<p><code>recv_queue</code>ä»£è¡¨å½“å‰ç«¯ç‚¹ç»´æŠ¤çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒä½¿ç”¨<code>VecDeque</code>æ¥å­˜æ”¾<code>MessagePacket</code>ï¼Œå¯ä»¥é€šè¿‡<code>pop_front()</code>ã€<code>push_back</code>ç­‰æ–¹æ³•åœ¨é˜Ÿå¤´å¼¹å‡ºæ•°æ®å’Œåœ¨é˜Ÿå°¾å‹å…¥æ•°æ®ã€‚</p>
<p>ç”¨ä½¿ç”¨å®è‡ªåŠ¨å®ç° <code>KernelObject</code> trait ï¼Œä½¿ç”¨channelç±»å‹åï¼Œå¹¶æ·»åŠ ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<pre><code class="language-rust noplaypen">impl_kobject!(Channel
    fn peer(&amp;self) -&gt; ZxResult&lt;Arc&lt;dyn KernelObject&gt;&gt; {
        let peer = self.peer.upgrade().ok_or(ZxError::PEER_CLOSED)?;
        Ok(peer)
    }
    fn related_koid(&amp;self) -&gt; KoID {
        self.peer.upgrade().map(|p| p.id()).unwrap_or(0)
    }
);
</code></pre>
<h3 id="å®ç°åˆ›å»ºchannelçš„æ–¹æ³•"><a class="header" href="#å®ç°åˆ›å»ºchannelçš„æ–¹æ³•">å®ç°åˆ›å»ºChannelçš„æ–¹æ³•</a></h3>
<p>ä¸‹é¢æˆ‘ä»¬æ¥å®ç°åˆ›å»ºä¸€ä¸ª<code>Channel</code>çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-rust noplaypen">impl Channel {

    #[allow(unsafe_code)]
    pub fn create() -&gt; (Arc&lt;Self&gt;, Arc&lt;Self&gt;) {
        let mut channel0 = Arc::new(Channel {
            base: KObjectBase::default(),
            peer: Weak::default(),
            recv_queue: Default::default(),
        });
        let channel1 = Arc::new(Channel {
            base: KObjectBase::default(),
            peer: Arc::downgrade(&amp;channel0),
            recv_queue: Default::default(),
        });
        // no other reference of `channel0`
        unsafe {
            Arc::get_mut_unchecked(&amp;mut channel0).peer = Arc::downgrade(&amp;channel1);
        }
        (channel0, channel1)
}
</code></pre>
<p>è¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸¤ç«¯ç‚¹ç»“æ„ä½“ï¼ˆChannelï¼‰çš„<code>Arc</code>å¼•ç”¨ï¼Œè¿™å°†ä½œä¸ºå†…æ ¸å¯¹è±¡è¢«å†…æ ¸ä¸­çš„å…¶ä»–æ•°æ®ç»“æ„å¼•ç”¨ã€‚ä¸¤ä¸ªç«¯ç‚¹äº’ç›¸æŒæœ‰å¯¹æ–¹<code>Weak</code>æŒ‡é’ˆï¼Œè¿™æ˜¯å› ä¸ºä¸€ä¸ªç«¯ç‚¹æ— éœ€å¼•ç”¨è®¡æ•°ä¸º0ï¼Œåªè¦<code>strong_count</code>ä¸º0å°±å¯ä»¥è¢«æ¸…ç†æ‰ï¼Œå³ä½¿å¦ä¸€ä¸ªç«¯ç‚¹æŒ‡å‘å®ƒã€‚</p>
<blockquote>
<p>rust è¯­è¨€å¹¶æ²¡æœ‰æä¾›åƒåœ¾å›æ”¶ (GC, Garbage Collection ) çš„åŠŸèƒ½ï¼Œ ä¸è¿‡å®ƒæä¾›äº†æœ€ç®€å•çš„å¼•ç”¨è®¡æ•°åŒ…è£…ç±»å‹ <code>Rc</code>ï¼Œè¿™ç§å¼•ç”¨è®¡æ•°åŠŸèƒ½ä¹Ÿæ˜¯æ—©æœŸ GC å¸¸ç”¨çš„æ–¹æ³•ï¼Œ ä½†æ˜¯å¼•ç”¨è®¡æ•°ä¸èƒ½è§£å†³å¾ªç¯å¼•ç”¨ã€‚é‚£ä¹ˆå¦‚ä½• fix è¿™ä¸ªå¾ªç¯å¼•ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <code>Weak</code> æŒ‡é’ˆï¼Œåªå¢åŠ å¼•ç”¨é€»è¾‘ï¼Œä¸å…±äº«æ‰€æœ‰æƒï¼Œå³ä¸å¢åŠ  strong reference countã€‚ç”±äº <code>Weak</code> æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡å¯èƒ½ææ„äº†ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è§£å¼•ç”¨ï¼Œè¦æ¨¡å¼åŒ¹é…ï¼Œå† upgradeã€‚</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ª<code>unsafe</code>ä»£ç å—ï¼š</p>
<pre><code class="language-rust noplaypen">unsafe {
            Arc::get_mut_unchecked(&amp;mut channel0).peer = Arc::downgrade(&amp;channel1);
        }
</code></pre>
<p>ç”±äºä¸¤ç«¯çš„ç»“æ„ä½“å°†åˆ†åˆ«é€šè¿‡ <code>Arc</code> å¼•ç”¨ï¼Œä½œä¸ºå†…æ ¸å¯¹è±¡è€Œè¢«å†…æ ¸ä¸­çš„å…¶ä»–æ•°æ®ç»“æ„ä½¿ç”¨ã€‚å› æ­¤ï¼Œåœ¨åŒæ—¶åˆå§‹åŒ–ä¸¤ç«¯çš„åŒæ—¶ï¼Œå°†å¿…é¡»å¯¹æŸä¸€ç«¯çš„ Arc æŒ‡é’ˆè¿›è¡Œè·å–å¯å˜å¼•ç”¨çš„æ“ä½œï¼Œå³<code>get_mut_unchecked</code>æ¥å£ã€‚å½“ <code>Arc</code> æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ä¸ä¸º <code>1</code> æ—¶ï¼Œè¿™ä¸€æ¥å£æ˜¯éå¸¸ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯åœ¨å½“å‰æƒ…å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸€æ¥å£è¿›è¡Œ<code>IPC</code> å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œå®‰å…¨æ€§æ˜¯å¯ä»¥ä¿è¯çš„ã€‚</p>
<h3 id="å•å…ƒæµ‹è¯•"><a class="header" href="#å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</a></h3>
<p>ä¸‹é¢æˆ‘ä»¬å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œæ¥éªŒè¯æˆ‘ä»¬å†™çš„<code>create</code>æ–¹æ³•ï¼š</p>
<pre><code class="language-rust noplaypen">#[test]
    fn test_basics() {
        let (end0, end1) = Channel::create();
        assert!(Arc::ptr_eq(
            &amp;end0.peer().unwrap().downcast_arc().unwrap(),
            &amp;end1
        ));
        assert_eq!(end0.related_koid(), end1.id());

        drop(end1);
        assert_eq!(end0.peer().unwrap_err(), ZxError::PEER_CLOSED);
        assert_eq!(end0.related_koid(), 0);
    }
</code></pre>
<h3 id="å®ç°æ•°æ®ä¼ è¾“"><a class="header" href="#å®ç°æ•°æ®ä¼ è¾“">å®ç°æ•°æ®ä¼ è¾“</a></h3>
<p>Channelä¸­çš„æ•°æ®ä¼ è¾“ï¼Œå¯ä»¥ç†è§£ä¸º<code>MessagePacket</code>åœ¨ä¸¤ä¸ªç«¯ç‚¹ä¹‹é—´çš„ä¼ è¾“ï¼Œé‚£ä¹ˆè°å¯ä»¥è¯»å†™æ¶ˆæ¯å‘¢ï¼Ÿ</p>
<p>æœ‰ä¸€ä¸ªå¥æŸ„ä¸é€šé“ç«¯ç‚¹ç›¸å…³è”ï¼ŒæŒæœ‰è¯¥å¥æŸ„çš„è¿›ç¨‹è¢«è§†ä¸ºæ‰€æœ‰è€…ï¼ˆownerï¼‰ã€‚æ‰€ä»¥æ˜¯ï¼ˆæŒæœ‰ä¸é€šé“ç«¯ç‚¹å…³è”å¥æŸ„çš„ï¼‰è¿›ç¨‹å¯ä»¥è¯»å–æˆ–å†™å…¥æ¶ˆæ¯ï¼Œæˆ–å°†é€šé“ç«¯ç‚¹å‘é€åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚</p>
<p>å½“<code>MessagePacket</code>è¢«å†™å…¥é€šé“æ—¶ï¼Œå®ƒä»¬ä¼šä»å‘é€è¿›ç¨‹ä¸­åˆ é™¤ã€‚å½“ä»é€šé“è¯»å–<code>MessagePacket</code>æ—¶ï¼Œ<code>MessagePacket</code>çš„å¥æŸ„è¢«æ·»åŠ åˆ°æ¥æ”¶è¿›ç¨‹ä¸­ã€‚</p>
<h4 id="read"><a class="header" href="#read">read</a></h4>
<p>è·å–å½“å‰ç«¯ç‚¹çš„<code>recv_queue</code>ï¼Œä»é˜Ÿå¤´ä¸­è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœèƒ½è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¿”å›<code>Ok</code>ï¼Œå¦åˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</p>
<pre><code class="language-rust noplaypen">pub fn read(&amp;self) -&gt; ZxResult&lt;T&gt; {
        let mut recv_queue = self.recv_queue.lock();
        if let Some(_msg) = recv_queue.front() {
            let msg = recv_queue.pop_front().unwrap();
            return Ok(msg);
        }
        if self.peer_closed() {
            Err(ZxError::PEER_CLOSED)
        } else {
            Err(ZxError::SHOULD_WAIT)
        }
    }
</code></pre>
<h4 id="write"><a class="header" href="#write">write</a></h4>
<p>å…ˆè·å–å½“å‰ç«¯ç‚¹å¯¹åº”çš„å¦ä¸€ä¸ªç«¯ç‚¹çš„<code>Weak</code>æŒ‡é’ˆï¼Œé€šè¿‡<code>upgrade</code>æ¥å£å‡çº§ä¸º<code>Arc</code>æŒ‡é’ˆï¼Œä»è€Œè·å–åˆ°å¯¹åº”çš„ç»“æ„ä½“å¯¹è±¡ã€‚åœ¨å®ƒçš„<code>recv_queue</code>é˜Ÿå°¾pushä¸€ä¸ª<code>MessagePacket</code>ã€‚</p>
<pre><code class="language-rust noplaypen">pub fn write(&amp;self, msg: T) -&gt; ZxResult {
        let peer = self.peer.upgrade().ok_or(ZxError::PEER_CLOSED)?;
        peer.push_general(msg);
        Ok(())
    }
fn push_general(&amp;self, msg: T) {
        let mut send_queue = self.recv_queue.lock();
        send_queue.push_back(msg);
    }
</code></pre>
<h3 id="å•å…ƒæµ‹è¯•-1"><a class="header" href="#å•å…ƒæµ‹è¯•-1">å•å…ƒæµ‹è¯•</a></h3>
<p>ä¸‹é¢æˆ‘ä»¬å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼ŒéªŒè¯æˆ‘ä»¬ä¸Šé¢å†™çš„<code>read</code>å’Œ<code>write</code>ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="language-rust noplaypen">#[test]
    fn read_write() {
        let (channel0, channel1) = Channel::create();
        // write a message to each other
        channel0
            .write(MessagePacket {
                data: Vec::from(&quot;hello 1&quot;),
                handles: Vec::new(),
            })
            .unwrap();

        channel1
            .write(MessagePacket {
                data: Vec::from(&quot;hello 0&quot;),
                handles: Vec::new(),
            })
            .unwrap();

		// read message should success
        let recv_msg = channel1.read().unwrap();
        assert_eq!(recv_msg.data.as_slice(), b&quot;hello 1&quot;);
        assert!(recv_msg.handles.is_empty());

        let recv_msg = channel0.read().unwrap();
        assert_eq!(recv_msg.data.as_slice(), b&quot;hello 0&quot;);
        assert!(recv_msg.handles.is_empty());

        // read more message should fail.
        assert_eq!(channel0.read().err(), Some(ZxError::SHOULD_WAIT));
        assert_eq!(channel1.read().err(), Some(ZxError::SHOULD_WAIT));
    }
</code></pre>
<h2 id="æ€»ç»“"><a class="header" href="#æ€»ç»“">æ€»ç»“</a></h2>
<p>åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬å®ç°äº†å”¯ä¸€ä¸€ä¸ªå¯ä»¥ä¼ é€’å¥æŸ„çš„å¯¹è±¡ä¼ è¾“å™¨â€”â€”Channelï¼Œæˆ‘ä»¬å…ˆäº†è§£çš„Zirconä¸­ä¸»è¦çš„IPCå†…æ ¸å¯¹è±¡ï¼Œå†ä»‹ç»äº†Channelå¦‚ä½•åˆ›å»ºå’Œå®ç°readå’Œwriteå‡½æ•°çš„ç»†èŠ‚ã€‚</p>
<p>æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº†ä¸­æœ€æ ¸å¿ƒçš„å‡ ä¸ªå†…æ ¸å¯¹è±¡ï¼Œåœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ <code>Zircon</code>çš„ä»»åŠ¡ç®¡ç†ä½“ç³»å’Œè¿›ç¨‹ã€çº¿ç¨‹ç®¡ç†çš„å¯¹è±¡ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="ch01-02-process-object.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="ch02-00-task.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="ch01-02-process-object.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="ch02-00-task.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
                <script src="ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
